<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ç†è²¡å°å¯Œç¿ï¼ˆè·æ¶¯ Ã— èª²ç¨‹ Ã— æŠ•è³‡äº‹æ¥­ Ã— ä¿éšªï¼‰</title>
<style>
  :root{
    --primary:#5d9cec; --panel:#ffffff; --bg:#f0f8ff; --ink:#0f172a;
    --accent:#8fb3ff; --good:#2e7d32; --bad:#c62828; --muted:#64748b;
  }
  *{box-sizing:border-box}
  body{font-family:"Noto Sans TC",Arial,sans-serif;background:var(--bg);color:var(--ink);margin:0;padding:12px}
  .layout{display:flex; gap:16px; align-items:flex-start; justify-content:center; max-width:1400px; margin:0 auto;}
  .leftCol{flex:0 0 560px; display:flex; flex-direction:column; gap:12px}
  .rightCol{flex:0 1 auto}
  .panel{background:var(--panel); border-radius:14px; box-shadow:0 6px 18px rgba(0,0,0,.12); padding:12px;}
  h1{margin:0 0 12px; text-align:center}
  .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
  input,select{padding:6px;border-radius:8px;border:1px solid #cbd5e1}
  input[type=number]{width:120px}
  button{padding:8px 12px;border:0;border-radius:10px;background:var(--primary);color:#fff;font-size:14px;cursor:pointer}
  button.secondary{background:#e2e8f0;color:#111}
  small.helper{color:var(--muted)}

  /* é ­åƒå¡ */
  #avatars{display:flex;flex-wrap:wrap;gap:10px}
  .avatar{position:relative;width:150px;border:2px solid #ccc;border-radius:12px;background:#fff8dc;cursor:pointer;padding:6px;display:flex;flex-direction:column;align-items:center;gap:6px;transition:transform .15s,border-color .2s}
  .avatar:hover{transform:translateY(-2px);border-color:var(--primary)}
  .avatar .imgWrap{position:relative;width:100%}
  .avatar img{width:100%;height:auto;object-fit:contain;border-radius:10px}
  .avatar span{font-size:14px;font-weight:700}
  .avatar .pickedName{position:absolute;left:6px;right:6px;bottom:6px;background:rgba(0,0,0,.6);color:#fff;font-weight:700;font-size:14px;padding:4px 6px;border-radius:8px;text-align:center;display:none}
  .avatar.selected{border-color:var(--primary);box-shadow:0 0 0 3px rgba(93,156,236,.25) inset}
  .avatar.selected .pickedName{display:block}
  .avatar:disabled{opacity:.6;cursor:not-allowed}

  /* è³‡è¨Šåˆ— */
  .stats{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:6px 0}
  .chip{background:#fff;border-radius:999px;padding:6px 10px;box-shadow:0 2px 8px rgba(0,0,0,.07);font-size:13px}
  .good{color:var(--good)} .bad{color:var(--bad)}
  .muted{color:var(--muted)}

  /* éª°å­èˆ‡å¡ */
  #dice{font-size:72px;cursor:pointer;user-select:none;margin-top:6px;text-align:center}
  #result{margin-top:6px;font-size:16px;text-align:center;color:#334155;min-height:22px}
  #card{display:none;border:2px solid var(--accent);padding:12px;margin:10px 0 0;border-radius:14px;background:#fff;box-shadow:0 6px 18px rgba(0,0,0,.12)}
  #card h3{margin:4px 0 6px}
  #card .amount{font-weight:700}

  /* æ£‹ç›¤ */
  .boardWrap{position:sticky; top:8px}
  .boardTitle{margin:0 0 8px}
  .board{display:grid; grid-template-columns:repeat(8, 70px); grid-template-rows:repeat(8, 70px); gap:4px; background:#dbeafe; padding:6px; border-radius:12px;}
  .cell{background:#eaf4ff;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:11px;color:#333}
  .tile{background:#fff;border:2px solid var(--accent);border-radius:10px;padding:3px;width:100%;height:100%;display:flex;flex-direction:column;justify-content:space-between}
  .tile h4{margin:0 2px 2px;font-size:11px;line-height:1.15}
  .pills{display:flex;flex-wrap:wrap;gap:2px;padding:2px 2px 0}
  .pill{display:inline-flex;flex-direction:column;align-items:center;font-size:9px;background:#eef3ff;border:1px solid #c7d8ff;border-radius:6px;padding:1px 3px}
  .pill .nm{font-size:9px;line-height:1;margin-top:1px;color:#111}
  #tileInfo{margin-top:6px;font-size:14px}

  /* è¡¨æ ¼ */
  #holdings{width:100%; overflow:auto; border-top:1px dashed #cbd5e1; margin-top:8px; padding-top:8px}
  #holdings table{width:100%; border-collapse:collapse; font-size:12px}
  #holdings th,#holdings td{border-bottom:1px solid #eef2f7; padding:6px 4px; text-align:right}
  #holdings th:first-child,#holdings td:first-child{text-align:left}
  .pl{color:var(--good)} .mn{color:var(--bad)}

  details{margin-top:8px}
  summary{cursor:pointer}

  /* éŠ€è¡Œå€å¡Š */
  #bankActions{display:none;border-top:1px dashed #cbd5e1; margin-top:8px; padding-top:8px}
  #loanList{width:100%}
  #loanList table{width:100%; border-collapse:collapse; font-size:12px}
  #loanList th,#loanList td{border-bottom:1px solid #eef2f7; padding:6px 4px; text-align:right}
  #loanList th:first-child,#loanList td:first-child{text-align:left}
  .careerBox{background:#f8fbff;border:1px solid #dbeafe;border-radius:10px;padding:8px;margin-top:8px}

  /* Toast */
  #toast{position:fixed;right:16px;bottom:16px;z-index:9999;display:flex;flex-direction:column;gap:8px}
  .toast{background:#111827;color:#fff;border-radius:10px;padding:10px 12px;box-shadow:0 8px 20px rgba(0,0,0,.2);opacity:.95;font-size:14px}
  .toast.good{background:#065f46}
  .toast.bad{background:#7f1d1d}

  @media (max-width: 1020px){
    .layout{flex-direction:column}
    .leftCol,.rightCol{width:100%}
    .board{grid-template-columns:repeat(8, 52px); grid-template-rows:repeat(8, 52px)}
  }
</style>
</head>
<body>
  <h1>ğŸ² ç†è²¡å°å¯Œç¿ï¼ˆé€²éšè·æ¶¯ç‰ˆï¼‰</h1>

  <div class="layout">
    <div class="leftCol">
      <div class="panel" id="setup">
        <h3>ç©å®¶èˆ‡è¦å‰‡</h3>
        <div class="row">
          <input id="nameInput" placeholder="è«‹è¼¸å…¥ç©å®¶åç¨±"/>
          <div>åˆå§‹é‡‘é¡ï¼š<input id="startMoney" type="number" min="0" step="100" value="3000" style="width:120px"></div>
          <div>å›åˆä¸Šé™ï¼š<input type="number" id="roundLimit" min="1" max="200" value="200" style="width:90px"></div>
        </div>
        <div class="row">
          <label>é¸æ“‡è·æ¥­ï¼š
            <select id="jobSelect"></select>
          </label>
          <span class="muted"><small class="helper">æ¯åœˆç™¼è–ªï¼›å‡è·éœ€å¹´è³‡ï¼ˆåœˆæ•¸ï¼‰ï¼‹å¿…è¦èª²ç¨‹</small></span>
        </div>
        <p style="margin:6px 0">é»ä¸‹æ–¹å‹•ç‰©åŠ å…¥ï¼ˆæœ€å¤š 8 äººï¼‰ï¼š</p>
        <div id="avatars"></div>
        <div class="row" style="margin-top:8px">
          <button id="startGame">é–‹å§‹éŠæˆ²</button>
          <button id="quickNew" class="secondary">æ–°å±€ï¼ˆä¿ç•™ç©å®¶ï¼Œä¸è®Šæ›´æ£‹ç›¤ï¼‰</button>
          <button id="reseedNew" class="secondary">æ–°å±€ï¼‹é‡æŠ½æ£‹ç›¤</button>
          <button id="saveGame" class="secondary">å„²å­˜</button>
          <button id="loadGame" class="secondary">è¼‰å…¥</button>
          <button id="newSlot" class="secondary">æ–°å­˜æª”ä½</button>
        </div>
      </div>

      <div class="panel" id="game" style="display:none">
        <h3>ç›®å‰ç©å®¶ï¼š <span id="currentPlayerName"></span></h3>
        <div class="row"><span>å›åˆï¼š<span id="roundNow">1</span>/<span id="roundMax">200</span></span></div>
        <div class="stats">
          <div class="chip">è·æ¥­ï¼š<strong id="jobNow">â€”</strong></div>
          <div class="chip">è·ç­‰ï¼š<strong id="rankNow">â€”</strong></div>
          <div class="chip good">ç¸½æ”¶å…¥ï¼š<span id="income">0</span></div>
          <div class="chip bad">ç¸½æ”¯å‡ºï¼š<span id="expense">0</span></div>
          <div class="chip">ç¾é‡‘é¤˜é¡ï¼š<strong id="balance">0</strong></div>
          <div class="chip">å­˜æ¬¾ï¼š<strong id="bankDep">0</strong></div>
          <div class="chip">è²¸æ¬¾é¤˜é¡ï¼š<strong id="loanOut">0</strong></div>
          <div class="chip">è³‡ç”¢æ·¨å€¼ï¼š<strong id="networth">0</strong></div>
          <div class="chip">è‚¡ç¥¨ï¼š<strong id="stockSummary">â€”</strong></div>
        </div>

        <div id="dice" title="é»æˆ‘æ“²éª°">ğŸ²</div>
        <div id="result"></div>

        <div id="card">
          <div class="row">
            <div style="display:flex;flex-direction:column;align-items:center;gap:4px">
              <img id="cardAvatar" alt="è§’è‰²" style="width:72px;height:72px;border-radius:12px;object-fit:cover"/>
              <div id="characterName" style="font-weight:600"></div>
            </div>
            <div style="flex:1;min-width:300px">
              <h3 id="cardTitle">äº‹ä»¶å¡</h3>
              <p id="cardText">å…§å®¹æœƒåœ¨é€™è£¡å‡ºç¾</p>
              <p class="amount" id="cardAmount"></p>

              <!-- è‚¡ç¥¨æ“ä½œåˆ—ï¼ˆä¿ç•™ï¼‰ -->
              <div id="stockActions" class="row" style="display:none">
                <div>ğŸ“ˆ æ¨™çš„ï¼š
                  <select id="stockSelect"></select>
                </div>
                <div>å¸‚åƒ¹ï¼š<b id="stockPrice"></b></div>
                <div>æ®–åˆ©ç‡ï¼š<b id="stockYield"></b></div>
                <div>æ•¸é‡ï¼š<input id="stockQty" type="number" min="1" value="1" style="width:80px"></div>
                <label class="row" style="align-items:center;gap:4px">
                  <input id="useLoanStock" type="checkbox"> ä½¿ç”¨è²¸æ¬¾
                </label>
                <label>å¹´é™ï¼š
                  <select id="stockLoanYears">
                    <option value="1">1 å¹´</option><option value="2">2 å¹´</option>
                    <option value="3" selected>3 å¹´</option><option value="4">4 å¹´</option><option value="5">5 å¹´</option>
                  </select>
                </label>
                <button id="btnBuy">è²·å…¥</button>
                <button id="btnSell" class="secondary">è³£å‡º</button>
              </div>

              <!-- æŠ•è³‡äº‹æ¥­æ“ä½œåˆ— -->
              <div id="ventureActions" class="row" style="display:none">
                <div>ğŸ“¦ äº‹æ¥­ï¼š<b id="ventureName">â€”</b></div>
                <div>æˆåŠŸç‡ï¼š<b id="ventureChance">â€”</b></div>
                <div>é‡‘é¡ï¼š<input id="ventureAmt" type="number" min="100" step="100" value="500" style="width:120px"></div>
                <label class="row" style="align-items:center;gap:4px">
                  <input id="ventureUseLoan" type="checkbox"> ä½¿ç”¨è²¸æ¬¾
                </label>
                <label>å¹´é™ï¼š
                  <select id="ventureYears">
                    <option value="1">1 å¹´</option><option value="2">2 å¹´</option>
                    <option value="3" selected>3 å¹´</option><option value="4">4 å¹´</option><option value="5">5 å¹´</option>
                  </select>
                </label>
                <button id="btnInvest">æŠ•è³‡</button>
                <button id="btnSkipV" class="secondary">è·³é</button>
              </div>

              <!-- éŠ€è¡Œå­˜æ + è²¸æ¬¾æ¸…å–® + ä¿éšª + è·æ¶¯ -->
              <div id="bankActions">
                <div class="row">
                  <div>ğŸ¦ éŠ€è¡Œå­˜æ¬¾ï¼š<b id="bankBalance"></b>ï¼ˆå¹´åˆ©ç‡ <span id="bankRate"></span>ï¼‰</div>
                </div>
                <div class="row">
                  <input id="bankAmt" type="number" min="0" value="0" style="width:120px" />
                  <button id="btnDeposit">å­˜å…¥</button>
                  <button id="btnWithdraw" class="secondary">æé ˜</button>
                </div>
                <div class="careerBox" id="careerBox"></div>
                <div class="careerBox" id="insuranceBox"></div>
                <div id="loanList"></div>
              </div>

              <!-- æŒè‚¡è¡¨ -->
              <div id="holdings" style="display:none"></div>

              <div id="extraBtns" class="row" style="margin-top:6px">
                <button id="buyBtn" class="secondary" style="display:none">è³¼è²·/å‡ç´šåœ°ç”¢</button>
                <button id="okBtn">çŸ¥é“äº†</button>
                <button id="nextBtn" class="secondary">ä¸‹ä¸€ä½</button>
              </div>
            </div>
          </div>
        </div>

        <details>
          <summary>ğŸ“’ æ”¶æ”¯æ˜ç´°ï¼ˆç›®å‰ç©å®¶ï¼‰</summary>
          <ul id="ledger" style="text-align:left;max-height:240px;overflow:auto;margin:8px 0 0"></ul>
        </details>

        <details>
          <summary>ğŸ“Š æ’è¡Œï¼ˆæ·¨å€¼ï¼šç¾é‡‘+å­˜æ¬¾+åœ°ç”¢+è‚¡ç¥¨âˆ’è²¸æ¬¾ï¼‰</summary>
          <ol id="leaderboard" style="text-align:left;margin:8px 0 0"></ol>
        </details>
      </div>
    </div>

    <div class="rightCol">
      <div class="panel boardWrap">
        <h3 class="boardTitle">8Ã—8 èºæ—‹æ£‹ç›¤ï¼ˆå¤–æ¡†â†’å‘å…§ï¼‰</h3>
        <div id="board" class="board" aria-live="polite"></div>
        <div id="tileInfo">ä½ç½®ï¼šâ€”</div>
      </div>
    </div>
  </div>

  <div id="testOutput" style="display:none;white-space:pre-wrap;background:#fff;border:1px dashed #bbb;padding:8px;max-width:1200px;margin:10px auto"></div>
  <div id="toast" aria-live="polite"></div>

<script>
addEventListener('DOMContentLoaded', () => {
  // ========= å°å·¥å…· =========
  const $ = id => document.getElementById(id);
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const money = n => Number(n).toLocaleString('zh-TW', {maximumFractionDigits:0});
  const randInt=(min,max,rnd=Math.random)=>Math.floor(min + rnd()*(max-min+1));
  const nowStr = ()=> new Date().toLocaleString();

  function toast(msg, type=''){
    const box = $('toast'); const div = document.createElement('div');
    div.className = `toast ${type||''}`; div.textContent = msg;
    box.appendChild(div); setTimeout(()=>div.remove(), 3500);
  }

  // è§’è‰²åœ–ï¼šå…§åµŒ SVG
  function svgAnimal(emoji, bg){
    const svg = `<?xml version='1.0' encoding='UTF-8'?>
      <svg xmlns='http://www.w3.org/2000/svg' width='400' height='400'>
        <rect width='100%' height='100%' rx='40' ry='40' fill='${bg}'/>
        <circle cx='200' cy='150' r='120' fill='rgba(255,255,255,0.85)' />
        <text x='50%' y='58%' dominant-baseline='middle' text-anchor='middle' font-size='160'>${emoji}</text>
      </svg>`;
    return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
  }
  const CHARACTERS = [
    { name: 'å°ç†Š',   emoji:'ğŸ»', bg:'#FFD166' },
    { name: 'å°å…”',   emoji:'ğŸ°', bg:'#EF476F' },
    { name: 'å°ç‹—',   emoji:'ğŸ¶', bg:'#06D6A0' },
    { name: 'å°è²“',   emoji:'ğŸ±', bg:'#118AB2' },
    { name: 'å°è±¡',   emoji:'ğŸ˜', bg:'#8ECAE6' },
    { name: 'å°ç‹ç‹¸', emoji:'ğŸ¦Š', bg:'#FFB703' },
    { name: 'å°é³¥',   emoji:'ğŸ¦', bg:'#A3D9A5' },
    { name: 'å°ä¼éµ', emoji:'ğŸ§', bg:'#CBD5E1' }
  ].map(c => ({ ...c, img: svgAnimal(c.emoji, c.bg) }));

  // ========= è·æ¥­èˆ‡å‡è· =========
  const JOBS = [
    {id:'engineer', name:'å·¥ç¨‹å¸«', base:800, ranks:[
      {title:'åˆéš', req:{laps:0,  courses:{}}},
      {title:'ä¸­éš', req:{laps:6,  courses:{econ:1}}},
      {title:'é«˜éš', req:{laps:12, courses:{mgmt:1}}},
      {title:'ä¸»ç®¡', req:{laps:18, courses:{mgmt:2}}}
    ], mult:[1,1.4,1.9,2.6]},
    {id:'designer', name:'è¨­è¨ˆå¸«', base:700, ranks:[
      {title:'åˆéš', req:{laps:0,  courses:{}}},
      {title:'ä¸­éš', req:{laps:6,  courses:{finance:1}}},
      {title:'é«˜éš', req:{laps:12, courses:{mgmt:1}}},
      {title:'ç¸½ç›£', req:{laps:18, courses:{mgmt:2}}}
    ], mult:[1,1.4,1.9,2.5]},
    {id:'marketer', name:'è¡ŒéŠ·', base:650, ranks:[
      {title:'åŠ©ç†', req:{laps:0,  courses:{}}},
      {title:'å°ˆå“¡', req:{laps:6,  courses:{econ:1}}},
      {title:'è³‡æ·±', req:{laps:12, courses:{mgmt:1}}},
      {title:'ç¶“ç†', req:{laps:18, courses:{mgmt:2}}}
    ], mult:[1,1.45,2.0,2.7]},
    {id:'accountant', name:'æœƒè¨ˆ', base:750, ranks:[
      {title:'åˆéš', req:{laps:0,  courses:{}}},
      {title:'ä¸­éš', req:{laps:6,  courses:{finance:1}}},
      {title:'é«˜éš', req:{laps:12, courses:{econ:1}}},
      {title:'ç¶“ç†', req:{laps:18, courses:{mgmt:1}}}
    ], mult:[1,1.4,1.85,2.4]},
    {id:'sales', name:'æ¥­å‹™', base:600, ranks:[
      {title:'åŠ©ç†', req:{laps:0, courses:{}}},
      {title:'å°ˆå“¡', req:{laps:6, courses:{econ:1}}},
      {title:'è³‡æ·±', req:{laps:12, courses:{mgmt:1}}},
      {title:'ä¸»ç®¡', req:{laps:18, courses:{mgmt:2}}}
    ], mult:[1,1.5,2.1,2.9]},
    {id:'founder', name:'å‰µæ¥­è€…', base:500, ranks:[
      {title:'å‰µå®¢', req:{laps:0,  courses:{}}},
      {title:'å°è€é—†', req:{laps:6,  courses:{finance:1}}},
      {title:'åº—é•·', req:{laps:12, courses:{econ:1}}},
      {title:'ç¸½ç¶“ç†', req:{laps:18, courses:{mgmt:2}}}
    ], mult:[1,1.6,2.2,3.2]},
    {id:'analyst', name:'è³‡æ–™åˆ†æå¸«', base:780, ranks:[
      {title:'åˆéš', req:{laps:0,  courses:{}}},
      {title:'ä¸­éš', req:{laps:6,  courses:{econ:1}}},
      {title:'é«˜éš', req:{laps:12, courses:{finance:1}}},
      {title:'è³‡æ·±', req:{laps:18, courses:{mgmt:1}}}
    ], mult:[1,1.45,1.95,2.6]},
    {id:'pm', name:'ç”¢å“ç¶“ç†', base:820, ranks:[
      {title:'åŠ©ç†', req:{laps:0,  courses:{}}},
      {title:'PM',  req:{laps:6,  courses:{econ:1}}},
      {title:'è³‡æ·±', req:{laps:12, courses:{mgmt:1}}},
      {title:'ä¸»ç®¡', req:{laps:18, courses:{mgmt:2}}}
    ], mult:[1,1.4,1.9,2.7]},
  ];
  function jobById(id){ return JOBS.find(j=>j.id===id)||JOBS[0]; }
  function salaryOf(p){
    const j=jobById(p.jobId), r=p.jobRank||0; return Math.round(j.base * (j.mult[r]||1));
  }
  function canPromote(p){
    const j=jobById(p.jobId); const r=p.jobRank||0;
    if(r>=j.ranks.length-1) return {ok:false, info:'å·²é”é ‚éš'};
    const next=j.ranks[r+1]; const needLaps=(p.laps||0)>=next.req.laps;
    const needCourses=Object.entries(next.req.courses||{}).every(([k,v])=>(p.courses?.[k]||0)>=v);
    return {ok: needLaps && needCourses, next, reason: {needLaps, needCourses}};
  }

  // ========= DOM åƒç…§ =========
  const nameInput=$('nameInput'), startMoneyInput=$('startMoney'), roundLimitInput=$('roundLimit');
  const jobSelect=$('jobSelect');

  const avatarsEl=$('avatars');
  const startBtn=$('startGame'), quickNewBtn=$('quickNew'), reseedNewBtn=$('reseedNew');
  const saveBtn=$('saveGame'), loadBtn=$('loadGame'), newSlotBtn=$('newSlot');

  const gameEl=$('game'), setupEl=$('setup'), leftCol=document.querySelector('.leftCol');

  const currentPlayerNameEl=$('currentPlayerName');
  const roundNowEl=$('roundNow'), roundMaxEl=$('roundMax');
  const incomeEl=$('income'), expenseEl=$('expense'), balanceEl=$('balance');
  const networthEl=$('networth'), stockSummaryEl=$('stockSummary'), bankDepEl=$('bankDep'), loanOutEl=$('loanOut');
  const jobNowEl=$('jobNow'), rankNowEl=$('rankNow');

  const diceEl=$('dice'), resultEl=$('result');
  const cardEl=$('card'), cardAvatarEl=$('cardAvatar'), characterNameEl=$('characterName'), cardTitleEl=$('cardTitle'), cardTextEl=$('cardText'), cardAmountEl=$('cardAmount');

  const stockActionsEl=$('stockActions'), stockPriceEl=$('stockPrice'), stockYieldEl=$('stockYield'), stockQtyEl=$('stockQty'), stockSelectEl=$('stockSelect'), useLoanStockEl=$('useLoanStock'), stockLoanYearsEl=$('stockLoanYears'), btnBuy=$('btnBuy'), btnSell=$('btnSell');
  const ventureActionsEl=$('ventureActions'), ventureNameEl=$('ventureName'), ventureChanceEl=$('ventureChance'), ventureAmtEl=$('ventureAmt'), ventureUseLoanEl=$('ventureUseLoan'), ventureYearsEl=$('ventureYears'), btnInvest=$('btnInvest'), btnSkipV=$('btnSkipV');

  const holdingsEl=$('holdings');

  const bankActionsEl=$('bankActions'), bankBalanceEl=$('bankBalance'), bankRateEl=$('bankRate'), bankAmtEl=$('bankAmt'), btnDeposit=$('btnDeposit'), btnWithdraw=$('btnWithdraw'), loanListEl=$('loanList'), careerBoxEl=$('careerBox'), insuranceBoxEl=$('insuranceBox');

  const buyBtn=$('buyBtn'), okBtn=$('okBtn'), nextBtn=$('nextBtn'), extraBtns=$('extraBtns');

  const boardEl=$('board'), tileInfoEl=$('tileInfo'), ledgerEl=$('ledger'), leaderboardEl=$('leaderboard'), testOutput=$('testOutput');

  // ========= ç‹€æ…‹ =========
  let players=[]; let currentIndex=0; let gameOver=false;
  let roundNow=1; let roundMax=200;
  const allLedger=[];
  const GRID=8;
  let marketTimer=null;

  // å­˜æª”ï¼ˆlocalStorageï¼‰
  let saveSlot = localStorage.getItem('mg_active_slot') || 'slot1';
  function gameSnapshot(){
    return {
      version: 3,
      saveAt: Date.now(),
      saveSlot,
      players,
      currentIndex, gameOver, roundNow, roundMax,
      TILES,
      MARKET: { price: MARKET.price, yield: MARKET.yield, bias: MARKET.bias, halted: MARKET.halted }
    };
  }
  function gameRestore(snap){
    try{
      if(!snap || snap.version<2) return false;
      players = snap.players || [];
      currentIndex = snap.currentIndex||0; gameOver = !!snap.gameOver;
      roundNow = snap.roundNow||1; roundMax = snap.roundMax||200;
      TILES = snap.TILES || TILES;
      MARKET.price = snap.MARKET?.price || MARKET.price;
      MARKET.yield = snap.MARKET?.yield || MARKET.yield;
      MARKET.bias  = snap.MARKET?.bias  || {};
      MARKET.halted = snap.MARKET?.halted || {};
      return true;
    }catch(e){ console.error('restore error', e); return false; }
  }
  function saveToSlot(slot){ const key=`mg_${slot}`; localStorage.setItem(key, JSON.stringify(gameSnapshot())); localStorage.setItem('mg_active_slot', slot); saveSlot=slot; toast(`å·²å„²å­˜åˆ° ${slot} âœ…`,'good'); }
  function loadFromSlot(slot){ const key=`mg_${slot}`; const raw=localStorage.getItem(key); if(!raw){ toast(`æ‰¾ä¸åˆ° ${slot} çš„å­˜æª”`,`bad`); return false; } const ok=gameRestore(JSON.parse(raw)); if(ok){ localStorage.setItem('mg_active_slot',slot); saveSlot=slot; toast(`å·²å¾ ${slot} è¼‰å…¥ âœ…`,'good'); gameEl.style.display='block'; renderStats(); renderBoard(); } return ok; }
  function autoSave(){ if(!players?.length) return; const key=`mg_${saveSlot}`; localStorage.setItem(key, JSON.stringify(gameSnapshot())); }

  // å°ç£æƒ…å¢ƒåˆ©ç‡ï¼ˆå¯ä¾éœ€è¦èª¿æ•´ï¼‰
  const RATES = {
    depositAPY: 0.015,              // éŠ€è¡Œæ´»å­˜å¹´åˆ©ç‡ï¼ˆç´„ 1.5%ï¼‰
    loanPropertyBase: 0.025,        // åœ°ç”¢è²¸æ¬¾å¹´åˆ©ç‡èµ·é»
    loanStockBase: 0.045            // è‚¡ç¥¨èè³‡å¹´åˆ©ç‡èµ·é»
  };
  function rateFor(purpose, years){ const y = clamp(parseInt(years,10)||1,1,5); if(purpose==='property') return RATES.loanPropertyBase + (y-1)*0.002; return RATES.loanStockBase + (y-1)*0.003; }
  const PER_LAP = 12; // ä¸€åœˆè¦–ç‚ºã€Œæœˆã€

  // ä¿éšª
  const INSURANCE = { premium: 600, claim: 800 };

  // === è‚¡ç¥¨å¸‚å ´ï¼š20 æª”ï¼ˆå«æ®–åˆ©ç‡ï¼‰ï¼Œæ¼²è·Œå¹…é™åˆ¶ Â±10%ï¼Œæ–°èåç§»èˆ‡åœç‰Œ ===
  const MARKET={
    list: [
      {symbol:'LION', name:'é›„ç…'}, {symbol:'BEAR', name:'æ£•ç†Š'}, {symbol:'FOX', name:'ç‹ç‹¸'},
      {symbol:'CAT', name:'å°è²“'}, {symbol:'DOG', name:'å°ç‹—'}, {symbol:'RABT', name:'å°å…”'},
      {symbol:'TIGR', name:'è€è™'}, {symbol:'PAND', name:'ç†Šè²“'}, {symbol:'DEER', name:'æ¢…èŠ±é¹¿'},
      {symbol:'WOLF', name:'ç°ç‹¼'}, {symbol:'EAGL', name:'è€é·¹'}, {symbol:'OWLS', name:'è²“é ­é·¹'},
      {symbol:'DOLP', name:'æµ·è±š'}, {symbol:'SEAL', name:'æµ·è±¹'}, {symbol:'PENG', name:'ä¼éµ'},
      {symbol:'KOAL', name:'ç„¡å°¾ç†Š'}, {symbol:'SLOV', name:'æ¨¹æ‡¶'}, {symbol:'MICE', name:'å°é¼ '},
      {symbol:'HORS', name:'é§¿é¦¬'}, {symbol:'ZEBR', name:'æ–‘é¦¬'}
    ],
    price: {}, yield: {}, bias: {}, halted: {},
    init(){
      this.list.forEach((s,i)=>{
        this.price[s.symbol] = 60 + Math.round((i+1)* (240/this.list.length)) + Math.floor(Math.random()*20);
        this.yield[s.symbol] = +(0.02 + Math.random()*0.04).toFixed(3); // 2%~6%
      });
      this.bias={}; this.halted={};
    },
    news(){
      const p=Math.random();
      if(p<0.12){
        const s = this.list[Math.floor(Math.random()*this.list.length)];
        const sym=s.symbol; const t = Math.random();
        if(t<0.2){ this.halted[sym] = randInt(3,6); setNewsMsg(`ğŸ“° ${sym}ï¼ˆ${s.name}ï¼‰å› é‡å¤§è¨Šæ¯åœç‰Œ ${this.halted[sym]} æ¬¡ã€‚`); }
        else{
          const good = t<0.6; const b = (good?+1:-1) * (randInt(2,5)/100);
          this.bias[sym] = { b, ticks:randInt(3,6) };
          setNewsMsg(`ğŸ“° ${sym}ï¼ˆ${s.name}ï¼‰${good?'åˆ©å¤š':'åˆ©ç©º'}æ¶ˆæ¯ï¼ŒçŸ­æœŸæ³¢å‹•å${good?'æ­£':'è² '}ã€‚`);
        }
      }
    },
    tickAll(){
      this.news();
      for(const s of this.list){
        const sym=s.symbol;
        if(this.halted[sym]>0){ this.halted[sym]-=1; continue; }
        let base = (Math.random()*0.20)-0.10; // -10%~+10%
        if(this.bias[sym]?.ticks>0){ base += this.bias[sym].b; this.bias[sym].ticks -= 1; }
        base = Math.max(-0.10, Math.min(0.10, base));
        const p0=this.price[sym]; const np = Math.max(10, Math.round(p0*(1+base)));
        this.price[sym]=np;
      }
    }
  };
  MARKET.init();

  // 8Ã—8 èºæ—‹è·¯å¾‘
  function spiralPath(n){
    const res=[]; let top=0,bottom=n-1,left=0,right=n-1;
    while(left<=right && top<=bottom){
      for(let c=left;c<=right;c++) res.push(top*n+c);
      for(let r=top+1;r<=bottom;r++) res.push(r*n+right);
      if(top<bottom){ for(let c=right-1;c>=left;c--) res.push(bottom*n+c); }
      if(left<right){ for(let r=bottom-1;r>top;r--) res.push(r*n+left); }
      top++; right--; bottom--; left++;
    }
    return res;
  }
  const PATH=spiralPath(GRID);

  // æŠ•è³‡äº‹æ¥­
  const VENTURES = [
    {name:'å’–å•¡å°æ”¤', base:0.55, win:[0.10,0.40], lose:[-0.30,-0.10]},
    {name:'äºŒæ‰‹é›»å•†', base:0.60, win:[0.15,0.50], lose:[-0.35,-0.08]},
    {name:'æ‰‹ä½œå·¥åŠ', base:0.50, win:[0.12,0.45], lose:[-0.40,-0.12]},
    {name:'App å°å·¥å…·', base:0.45, win:[0.20,0.80], lose:[-0.45,-0.20]},
    {name:'ç¾é£Ÿé¤è»Š', base:0.50, win:[0.15,0.60], lose:[-0.50,-0.15]}
  ];

  // äº‹ä»¶å¡æ± ï¼ˆç§»é™¤åŸæœ¬å–®ç´”æ”¶æ”¯ï¼Œæ”¹ç‚ºï¼šèª²ç¨‹ / æŠ•è³‡äº‹æ¥­ / ä½é™¢ï¼‰
  const EVENTS=[
    { type:'course' }, { type:'course' }, { type:'course' },  // æé«˜æ©Ÿç‡é‡åˆ°èª²ç¨‹
    { type:'venture' }, { type:'venture' },
    { type:'injury' }
  ];

  // å»ºç›¤ï¼šå«åœ°ç”¢ï¼ˆä¸å†æ”¾ salary æ ¼ï¼‰
  function buildTiles(len){
    const tiles=[{ name:'èµ·é»', type:'start' }];
    let propId=1;
    const weights={ event:0.35, shop:0.12, stock:0.12, tax:0.08, donate:0.05, property:0.28 };
    const keys=Object.keys(weights);
    const pick=()=>{ let r=Math.random(); let acc=0; for(const k of keys){ acc+=weights[k]; if(r<=acc) return k; } return keys.at(-1); };
    for(let i=1;i<len;i++){
      const t=pick();
      if(t==='event')   tiles.push({ name:'äº‹ä»¶', type:'event' });
      else if(t==='shop')    tiles.push({ name:'å•†åº—', type:'shop', min:60, max:260 });
      else if(t==='stock')   tiles.push({ name:'è‚¡ç¥¨', type:'stock' });
      else if(t==='tax')     tiles.push({ name:'ç¨…é‡‘', type:'tax',  amount: randInt(80,180) });
      else if(t==='donate')  tiles.push({ name:'ææ¬¾', type:'donate',amount: randInt(60,140) });
      else if(t==='property'){
        const price=randInt(800,1600);
        const baseRent=Math.max(10, Math.floor(price*0.18));
        tiles.push({ name:`åœ°ç”¢ ${propId++}`, type:'property', price, baseRent, level:1, maxLevel:3, ownerIndex:null });
      }
    }
    return tiles;
  }
  let TILES=buildTiles(PATH.length);

  // === å¹«åŠ©è¨ˆç®—ï¼šåœ°ç”¢ / è‚¡ç¥¨ / éŠ€è¡Œ / è²¸æ¬¾ / æ·¨å€¼ ===
  function propertyValueForPlayer(playerIndex){
    let total=0;
    TILES.forEach(t=>{ if(t.type==='property' && t.ownerIndex===playerIndex){ total += (t.price||0) * (t.level||1); } });
    return total;
  }
  function loansOutstanding(player){ if(!player.loans?.length) return 0; return player.loans.reduce((s,l)=>s+(l.outstanding||0),0); }
  function stockValueOf(player){
    let total=0; if(!player?.stocks) return 0;
    for(const sym in player.stocks){ const {qty=0}=player.stocks[sym]||{}; const px = MARKET.price[sym]||0; total += qty * px; }
    return total;
  }
  function netWorthOf(player, playerIndex){
    return (player.balance||0) + (player.bankDeposit||0) + propertyValueForPlayer(playerIndex) + stockValueOf(player) - loansOutstanding(player);
  }

  // === UIï¼šè·æ¥­é¸å–® ===
  function buildJobSelect(){
    jobSelect.innerHTML = JOBS.map(j=>`<option value="${j.id}">${j.name}ï¼ˆåŸºè–ª $${j.base}ï¼‰</option>`).join('');
  }

  // === UIï¼šè§’è‰²é ­åƒ ===
  function buildAvatars(){
    avatarsEl.innerHTML='';
    CHARACTERS.forEach(c=>{
      const div=document.createElement('button');
      div.type='button'; div.className='avatar';
      const imgWrap=document.createElement('div'); imgWrap.className='imgWrap'; div.appendChild(imgWrap);

      const visual=document.createElement('div'); visual.style.fontSize='64px'; visual.style.lineHeight='1'; visual.textContent=c.emoji; imgWrap.appendChild(visual);
      const img=new Image(); img.alt=c.name; img.onload=()=>visual.replaceWith(img); img.src=c.img;

      const picked=document.createElement('div'); picked.className='pickedName'; picked.textContent=''; imgWrap.appendChild(picked);
      const label=document.createElement('span'); label.textContent=c.name; div.appendChild(label);

      div.addEventListener('click',()=>{
        const customName=nameInput?.value.trim(); const jobId=jobSelect?.value;
        if(!customName){ alert('è«‹å…ˆè¼¸å…¥åç¨±'); return; }
        if(!jobId){ alert('è«‹å…ˆé¸æ“‡è·æ¥­'); return; }
        if(players.length>=8){ alert('æœ€å¤š 8 ä½ç©å®¶'); return; }
        const stockBag={}; MARKET.list.forEach(s=>stockBag[s.symbol]={qty:0,avg:0});
        players.push({
          name:customName, img:(img.src||''), income:0, expense:0, balance:0, ledger:[],
          pos:0, stocks: stockBag, bankDeposit:0, loans:[], skipTurns:0, laps:0, 
          // è·æ¶¯
          jobId, jobRank:0, courses:{finance:0,econ:0,mgmt:0}, courseBuffNext:0,
          // æŠ•è³‡äº‹æ¥­/ä¿éšª
          pendingVenture:null, insured:false
        });
        picked.textContent=customName;
        div.classList.add('selected'); div.disabled=true;
        nameInput.value='';
        renderBoard(); renderStats();
      });

      avatarsEl.appendChild(div);
    });
  }

  // === æ£‹ç›¤ç¹ªè£½ ===
  function renderBoard(){
    if(!boardEl){ console.error('æ‰¾ä¸åˆ° #board'); return; }
    boardEl.innerHTML='';
    const total = GRID*GRID;
    for(let i=0;i<total;i++){
      const cell=document.createElement('div'); cell.className='cell'; cell.dataset.idx=i; boardEl.appendChild(cell);
    }
    if(!Array.isArray(PATH) || PATH.length!==total){
      boardEl.innerHTML = `<div style="padding:8px;color:#c62828;background:#fff;border-radius:8px">
        æ£‹ç›¤è·¯å¾‘ç”¢ç”Ÿå¤±æ•—ï¼ˆPATH é•·åº¦=${PATH?.length||'N/A'}ï¼Œæ‡‰ç‚º ${total}ï¼‰ã€‚è«‹é‡æ–°æ•´ç†æˆ–è²¼å›å®Œæ•´æª”æ¡ˆã€‚
      </div>`; return;
    }
    for(let k=0;k<TILES.length;k++){
      const boardIndex = PATH[k];
      const cell=boardEl.querySelector(`.cell[data-idx="${boardIndex}"]`); if(!cell) continue;
      const t=TILES[k]; const tile=document.createElement('div'); tile.className='tile';

      let own = '';
      if(t.type==='property'){ const lv = t.level || 1; own = (t.ownerIndex!=null) ? `<span style="float:right">ğŸ x${lv}</span>` : '<span style="float:right">ğŸ </span>'; }

      let sub='';
      if(t.type==='property'){ const rent = (t.baseRent||0) * (t.level||1); sub = `<small style="margin-left:6px">$ ${money(t.price)} / ç§Ÿ $ ${money(rent)}</small>`; }
      else if(t.amount){ sub = `<small style="margin-left:6px">$ ${money(t.amount)}</small>`; }

      tile.innerHTML=`<h4>${k+1}. ${t.name} ${own} ${sub}</h4><div class="pills" id="tile-${k}"></div>`;
      cell.innerHTML=''; cell.appendChild(tile);
    }
    players.forEach((pl)=>{
      const wrap=document.getElementById('tile-'+(pl.pos||0));
      if(wrap){
        const pill=document.createElement('span'); pill.className='pill';
        const top = document.createElement('span'); top.textContent='â—';
        const nm = document.createElement('span'); nm.className='nm'; nm.textContent=(pl.name||'P').slice(0,6);
        pill.appendChild(top); pill.appendChild(nm);
        wrap.appendChild(pill);
      }
    });
    const cp=players[currentIndex];
    if(cp){ const t=TILES[cp.pos||0]; tileInfoEl.textContent=`ä½ç½®ï¼šç¬¬ ${(cp.pos||0)+1} æ ¼ï¼ˆ${t.name}ï¼‰`; }
  }

  // === çµ±è¨ˆ ===
  function renderStats(){
    const p=players[currentIndex];
    currentPlayerNameEl.textContent=p?.name||'';
    incomeEl.textContent=money(p?.income??0);
    expenseEl.textContent=money(p?.expense??0);
    balanceEl.textContent=money(p?.balance??0);

    if(p){
      const pv = propertyValueForPlayer(currentIndex);
      const sv = stockValueOf(p);
      const dep = p.bankDeposit||0;
      const loan = loansOutstanding(p);
      const nw = (p.balance||0) + dep + pv + sv - loan;
      networthEl.textContent = money(nw);
      bankDepEl.textContent = money(dep);
      loanOutEl.textContent = money(loan);
      const held = Object.entries(p.stocks).filter(([sym,obj])=>(obj?.qty||0)>0).slice(0,4).map(([sym,obj])=>`${sym}:${obj.qty}`).join('ï¼Œ');
      stockSummaryEl.textContent = held || 'â€”';

      const j=jobById(p.jobId); jobNowEl.textContent = j.name;
      const r=j.ranks[p.jobRank||0]; rankNowEl.textContent = r?.title||'â€”';

      // æ˜ç´°
      ledgerEl.innerHTML='';
      p.ledger.slice().reverse().forEach(item=>{
        const li=document.createElement('li');
        li.textContent=`${item.time}ï½œ${p.name}ï½œ${item.tag||'â€”'}ï½œ${item.title}ï¼š${item.type==='income'?'+':'-'}${money(item.amount)}ï½œé¤˜é¡ ${money(item.balanceAfter)}`;
        li.style.color=item.type==='income'?'var(--good)':'var(--bad)';
        ledgerEl.appendChild(li);
      });

      // æ’è¡Œ
      leaderboardEl.innerHTML='';
      const ranked = players.map((pp,idx)=>({ pp, idx, pv: propertyValueForPlayer(idx), sv: stockValueOf(pp), dep: pp.bankDeposit||0, loan: loansOutstanding(pp) }))
        .map(r=>({ ...r, nw: (r.pp.balance||0)+r.dep+r.pv+r.sv-r.loan }))
        .sort((a,b)=>b.nw-a.nw);
      ranked.forEach(r=>{
        const li=document.createElement('li'); 
        li.textContent=`${r.pp.name}ï¼šæ·¨å€¼ ${money(r.nw)}ï¼ˆç¾é‡‘ ${money(r.pp.balance)}ï½œå­˜æ¬¾ ${money(r.dep)}ï½œåœ°ç”¢ ${money(r.pv)}ï½œè‚¡ç¥¨ ${money(r.sv)}ï½œè²¸æ¬¾ ${money(r.loan)}ï¼‰`;
        leaderboardEl.appendChild(li);
      });
    }else{
      networthEl.textContent='0'; stockSummaryEl.textContent='â€”';
    }

    roundNowEl.textContent=roundNow; roundMaxEl.textContent=roundMax;
    renderBoard();
  }

  function pushLedger(p, {title, amount, type='income', tag=''}){
    p.ledger.push({ time:nowStr(), player:p.name, title, amount:Math.abs(+amount||0), type, tag, balanceAfter:p.balance });
    allLedger.push({ time:nowStr(), player:p.name, title, amount:Math.abs(+amount||0), type, tag, balanceAfter:p.balance });
  }

  // === éŠ€è¡Œ/è²¸æ¬¾ ===
  function formatRate(r){ return (+(r*100).toFixed(2))+'%'; }
  function renderLoanList(p){
    const list = p.loans||[];
    if(!list.length){ loanListEl.innerHTML = `<div class="muted"><small>ç›®å‰ç„¡è²¸æ¬¾</small></div>`; return; }
    const rows=list.map(l=>`<tr>
      <td>${l.purpose==='property'?'åœ°ç”¢':(l.purpose==='stock'?'è‚¡ç¥¨':'æŠ•è³‡')}</td>
      <td>${l.name||'-'}</td>
      <td>${formatRate(l.rate)}</td>
      <td>${l.years} å¹´</td>
      <td>$ ${money(Math.round(l.payment))}</td>
      <td>$ ${money(Math.round(l.outstanding))}</td>
      <td>${l.remain} æœŸ</td>
    </tr>`);
    loanListEl.innerHTML = `
      <div style="font-weight:700;margin:6px 0 4px">è²¸æ¬¾æ¸…å–®ï¼ˆæ¯åœˆè‡ªå‹•æ”¶å–æœ¬æ¯ï¼‰</div>
      <table>
        <thead><tr><th>ç”¨é€”</th><th>æ¨™çš„</th><th>å¹´åˆ©ç‡</th><th>å¹´é™</th><th>æ¯åœˆæ‡‰ç¹³</th><th>é¤˜é¡</th><th>å‰©é¤˜æœŸæ•¸</th></tr></thead>
        <tbody>${rows.join('')}</tbody>
      </table>`;
  }
  function showCareerBox(p){
    const j=jobById(p.jobId); const r=p.jobRank||0; const cur=j.ranks[r]; const next=j.ranks[r+1];
    const sal=salaryOf(p);
    let html = `<div><b>ğŸ‘” è·æ¶¯</b>ï½œ${j.name}ï½œ${cur.title}ï½œæœ¬åœˆè–ªæ°´ $ ${money(sal)}</div>`;
    html += `<div class="muted">å¹´è³‡ï¼š${p.laps||0} åœˆï¼›èª²ç¨‹ï¼šç†è²¡${p.courses.finance}ï¼ç¶“æ¿Ÿ${p.courses.econ}ï¼ç®¡ç†${p.courses.mgmt}</div>`;
    if(next){
      const needs=Object.entries(next.req.courses||{}).map(([k,v])=>`${k==='finance'?'ç†è²¡':k==='econ'?'ç¶“æ¿Ÿ':'ç®¡ç†'}Ã—${v}`).join('ã€')||'â€”';
      html += `<div>ä¸‹ä¸€è·ç­‰ï¼š<b>${next.title}</b>ï¼ˆéœ€å¹´è³‡ ${next.req.laps} åœˆï¼›èª²ç¨‹ï¼š${needs}ï¼‰</div>`;
      const chk = canPromote(p);
      if(chk.ok){
        html += `<div style="margin-top:6px"><button id="btnPromote">å‡è· â†’ ${next.title}</button></div>`;
      }else{
        html += `<div class="muted" style="margin-top:6px"><small>å°šæœªç¬¦åˆå‡è·æ¢ä»¶</small></div>`;
      }
    }else{
      html += `<div class="muted"><small>å·²é”æœ€é«˜è·ç­‰</small></div>`;
    }
    careerBoxEl.innerHTML = html;
    const btn=$('btnPromote');
    if(btn){ btn.onclick=()=>{ p.jobRank+=1; toast(`ğŸ‰ ${p.name} å‡ä»» ${j.ranks[p.jobRank].title}ï¼`,'good'); renderStats(); showBankPanel(p); }; }
  }
  function showInsuranceBox(p){
    if(p.insured){
      insuranceBoxEl.innerHTML = `<div><b>ğŸ›¡ï¸ ä¿éšª</b>ï½œå·²æŠ•ä¿ï½œç†è³  $ ${money(INSURANCE.claim)}</div>`;
    }else{
      insuranceBoxEl.innerHTML = `<div><b>ğŸ›¡ï¸ ä¿éšª</b>ï½œæœªæŠ•ä¿ï½œä¸€æ¬¡æ€§ä¿è²» $ ${money(INSURANCE.premium)}ï¼ˆä½é™¢äº‹ä»¶å•Ÿå‹•ç†è³ ï¼‰ 
      <button id="btnBuyIns" class="secondary" style="margin-left:8px">è³¼è²·ä¿éšª</button></div>`;
      const b=$('btnBuyIns'); if(b){ b.onclick=()=>{
        if(players[currentIndex].balance < INSURANCE.premium){ alert('ç¾é‡‘ä¸è¶³'); return; }
        const p0=players[currentIndex];
        p0.balance -= INSURANCE.premium; p0.expense += INSURANCE.premium; p0.insured = true;
        pushLedger(p0,{title:'è³¼è²·ä¿éšª', amount:INSURANCE.premium, type:'expense', tag:'ğŸ›¡ï¸'});
        renderStats(); showInsuranceBox(p0);
      }; }
    }
  }
  function showBankPanel(p){
    bankActionsEl.style.display='block';
    bankBalanceEl.textContent = '$ '+money(p.bankDeposit||0);
    bankRateEl.textContent = formatRate(RATES.depositAPY);
    bankAmtEl.value = 0;
    renderLoanList(p);
    showCareerBox(p);
    showInsuranceBox(p);
    btnDeposit.onclick=()=>{
      const amt = Math.max(0, parseInt(bankAmtEl.value||'0',10));
      if(amt<=0) return; if(p.balance<amt){ alert('ç¾é‡‘ä¸è¶³'); return; }
      p.balance -= amt; p.bankDeposit = (p.bankDeposit||0)+amt;
      pushLedger(p,{title:`å­˜å…¥éŠ€è¡Œ`, amount:amt, type:'expense', tag:'ğŸ¦'}); renderStats(); showBankPanel(p);
    };
    btnWithdraw.onclick=()=>{
      const amt = Math.max(0, parseInt(bankAmtEl.value||'0',10));
      if(amt<=0) return; if((p.bankDeposit||0)<amt){ alert('å­˜æ¬¾ä¸è¶³'); return; }
      p.bankDeposit -= amt; p.balance += amt;
      pushLedger(p,{title:`è‡ªéŠ€è¡Œæé ˜`, amount:amt, type:'income', tag:'ğŸ¦'}); renderStats(); showBankPanel(p);
    };
  }

  function createLoan(p, {amount, purpose, years=3, name='' }){
    const rate = rateFor(purpose, years);
    const r = rate/PER_LAP; const n = years*PER_LAP;
    const pay = r>0 ? amount * r / (1 - Math.pow(1+r,-n)) : amount/n;
    const loan = {id:Math.random().toString(36).slice(2), purpose, years, name, rate, payment:pay, outstanding:amount, remain:n};
    p.loans.push(loan);
    pushLedger(p,{title:`å–å¾—${purpose==='property'?'åœ°ç”¢':purpose==='stock'?'è‚¡ç¥¨':'æŠ•è³‡'}è²¸æ¬¾ $${money(amount)}`, amount, type:'income', tag:'ğŸ’³'});
    p.balance += amount;
  }
  function processLoansEachLap(p){
    if(!p.loans?.length) return {paid:0,interestTotal:0};
    let paid=0, interestTotal=0;
    p.loans.forEach(l=>{
      if(l.remain<=0 || l.outstanding<=0) return;
      const r = l.rate/PER_LAP;
      const interest = l.outstanding * r;
      let principal = l.payment - interest; if(principal<0) principal=0; if(principal>l.outstanding) principal=l.outstanding;
      const pay = principal + interest;
      l.outstanding -= principal; l.remain -= 1;
      p.balance -= pay; p.expense += pay;
      interestTotal += interest; paid+=pay;
      pushLedger(p,{title:`è²¸æ¬¾ç¹³æ¬¾ï¼ˆ${l.name|| (l.purpose==='property'?'åœ°ç”¢':l.purpose)}ï¼‰`, amount:pay, type:'expense', tag:'ğŸ’³'});
    });
    const before = (p.loans||[]).length;
    p.loans = p.loans.filter(l=>l.outstanding>1 && l.remain>0);
    if(before>0 && (!p.loans || p.loans.length<before)) toast('ğŸ† æˆå°±ï¼šæ¸…å„Ÿè²¸æ¬¾','good');
    return {paid, interestTotal};
  }
  function processDepositInterestEachLap(p){
    const dep = p.bankDeposit||0; if(dep<=0) return 0;
    const interest = dep * (RATES.depositAPY/PER_LAP);
    p.bankDeposit += interest; p.income += interest;
    pushLedger(p,{title:`éŠ€è¡Œå­˜æ¬¾åˆ©æ¯`, amount:interest, type:'income', tag:'ğŸ¦'});
    return interest;
  }
  function processDividendsEachLap(p){
    let total=0;
    for(const s of MARKET.list){
      const sym=s.symbol; const {qty=0}=p.stocks[sym]||{}; if(qty<=0) continue;
      const px = MARKET.price[sym]||0; const dy = MARKET.yield[sym]||0;
      const div = qty * px * (dy/PER_LAP);
      if(div>0){ p.balance += div; p.income += div; total += div; }
    }
    if(total>0) pushLedger(p,{title:`è‚¡ç¥¨è‚¡åˆ©å…¥å¸³`, amount:total, type:'income', tag:'ğŸ’°'});
    return total;
  }

  // === å¸‚å ´/æŒè‚¡è¡¨ ===
  function renderHoldings(p, highlightSym=null){
    const rows = []; let any=false;
    for(const s of MARKET.list){
      const sym=s.symbol;
      const {qty=0, avg=0} = p.stocks[sym]||{};
      if(qty>0){
        any=true; const px = MARKET.price[sym]||0; const pl = (px-avg)*qty;
        rows.push(
          `<tr${highlightSym===sym?' style="background:#f3f7ff"':''}>
            <td>${sym}</td><td>${qty}</td><td>$ ${money(avg)}</td><td>$ ${money(px)}</td>
            <td class="${pl>=0?'pl':'mn'}">${pl>=0?'+':''}$ ${money(Math.abs(pl))}</td>
          </tr>`
        );
      }
    }
    if(!any){ holdingsEl.style.display='block'; holdingsEl.innerHTML = `<em style="color:#64748b">å°šç„¡æŒè‚¡</em>`; return; }
    holdingsEl.style.display='block';
    holdingsEl.innerHTML = `
      <div style="font-weight:700;margin:6px 0 4px">æˆ‘çš„æŒè‚¡</div>
      <table>
        <thead><tr><th>ä»£è™Ÿ</th><th>æ•¸é‡</th><th>å¹³å‡æˆæœ¬</th><th>ç¾åƒ¹</th><th>æœªå¯¦ç¾æç›Š</th></tr></thead>
        <tbody>${rows.join('')}</tbody>
      </table>
    `;
  }

  function setNewsMsg(msg){ resultEl.textContent = msg; setTimeout(()=>{ if(resultEl.textContent===msg) resultEl.textContent=''; }, 8000); }

  // === LAPï¼šéèµ·é»æ™‚è™•ç†ï¼ˆè–ªæ°´ï¼‹åˆ©æ¯ï¼‹è‚¡åˆ©ï¼‹è²¸æ¬¾ï¼‰ ===
  function onCompleteLap(p){
    p.laps = (p.laps||0)+1;

    // 0) ç™¼è–ª
    const sal = salaryOf(p); p.balance += sal; p.income += sal; pushLedger(p,{title:`è–ªæ°´ç™¼æ”¾`, amount:sal, type:'income', tag:'ğŸ‘”'});

    // 1) å­˜æ¬¾åˆ©æ¯
    processDepositInterestEachLap(p);
    // 2) è‚¡åˆ©
    processDividendsEachLap(p);
    // 3) è²¸æ¬¾ç¹³æ¬¾ï¼ˆæœ¬æ¯ï¼‰
    processLoansEachLap(p);
    renderStats();

    // 4) é¡¯ç¤ºéŠ€è¡Œæ“ä½œé¢æ¿ï¼ˆæ¯åœˆå¯å­˜/æã€è²·ä¿éšªã€å‡è·ï¼‰
    cardTitleEl.textContent='ğŸ¦ æœˆçµï¼ˆå®Œæˆä¸€åœˆï¼‰';
    cardTextEl.innerHTML=`è–ªæ°´ã€åˆ©æ¯ã€è‚¡åˆ©ã€è²¸æ¬¾å·²çµç®—ï¼Œå¯é¸æ“‡å­˜å…¥æˆ–æé ˜ï¼Œä¸¦æª¢è¦–ä¿éšªèˆ‡å‡è·æ¢ä»¶ã€‚`;
    cardAmountEl.textContent='';
    cardAvatarEl.src = p.img;
    characterNameEl.textContent=p.name;
    stockActionsEl.style.display='none'; holdingsEl.style.display='none';
    ventureActionsEl.style.display='none';
    showBankPanel(p);
    cardEl.style.display='block';

    okBtn.onclick = ()=>{ bankActionsEl.style.display='none'; cardEl.style.display='none'; };
  }

  // === æŠ•è³‡äº‹æ¥­ï¼šäº‹ä»¶èˆ‡çµç®— ===
  function offerVenture(p){
    const v = VENTURES[Math.floor(Math.random()*VENTURES.length)];
    const buff = clamp((p.courseBuffNext||0), 0, 0.3);
    const showChance = Math.min(0.95, v.base + buff);
    ventureNameEl.textContent = v.name;
    ventureChanceEl.textContent = Math.round(showChance*100)+'%';
    ventureAmtEl.value = 500;

    cardTitleEl.textContent='ğŸ“¦ æŠ•è³‡äº‹æ¥­';
    cardTextEl.innerHTML=`æ©Ÿæœƒï¼š<b>${v.name}</b>ã€‚<br>æˆåŠŸç‡ï¼ˆå«èª²ç¨‹åŠ æˆï¼‰ç´„ <b>${Math.round(showChance*100)}%</b>ï¼›è‹¥æˆåŠŸï¼Œå ±é…¬ç´„ <b>${Math.round(v.win[0]*100)}% ~ ${Math.round(v.win[1]*100)}%</b>ï¼›å¤±æ•—æå¤±ç´„ <b>${Math.round(-v.lose[0]*100)}% ~ ${Math.round(-v.lose[1]*100)}%</b>ã€‚<br>å¯è‡ªè¨‚æŠ•å…¥é‡‘é¡ï¼Œäº¦å¯ä½¿ç”¨éŠ€è¡Œè²¸æ¬¾ã€‚`;
    cardAmountEl.textContent='';

    stockActionsEl.style.display='none'; holdingsEl.style.display='none'; bankActionsEl.style.display='none';
    ventureActionsEl.style.display='flex';
    cardAvatarEl.src = p.img; characterNameEl.textContent=p.name;
    cardEl.style.display='block';

    btnInvest.onclick=()=>{
      const amt = Math.max(100, parseInt(ventureAmtEl.value||'500',10));
      const useLoan = ventureUseLoanEl.checked; const years = parseInt(ventureYearsEl.value||'3',10);
      if(useLoan) createLoan(p,{amount:amt, purpose:'venture', years, name:v.name});
      if(p.balance<amt){ alert('ç¾é‡‘ä¸è¶³ï¼Œè«‹ä½¿ç”¨è²¸æ¬¾æˆ–é™ä½é‡‘é¡'); return; }
      p.balance -= amt; p.expense += amt;
      p.pendingVenture = { ...v, amount:amt, agreed:true }; // è¨˜éŒ„
      pushLedger(p,{title:`æŠ•è³‡äº‹æ¥­ï¼${v.name}ï¼ˆæˆæœ¬ï¼‰`, amount:amt, type:'expense', tag:'ğŸ“¦'});
      toast(`å·²æŠ•å…¥ $${money(amt)} è‡³ ${v.name}ï¼Œä¸‹å›åˆè‡ªå‹•çµç®—ã€‚`,'good');
      ventureActionsEl.style.display='none'; cardEl.style.display='none'; renderStats(); autoSave();
    };
    btnSkipV.onclick=()=>{ ventureActionsEl.style.display='none'; cardEl.style.display='none'; };
  }
  function resolveVentureIfAnyAtTurnStart(p){
    const inv = p.pendingVenture;
    if(!inv || !inv.agreed){ return false; }
    // æˆåŠŸç‡ï¼šbase + èª²ç¨‹åŠ æˆï¼ˆæœ¬æ¬¡ç”¨å®Œæ­¸é›¶ï¼‰
    const buff = clamp((p.courseBuffNext||0),0,0.3);
    const chance = Math.min(0.95, inv.base + buff);
    const success = Math.random() < chance;
    let roi;
    if(success){ roi = inv.win[0] + Math.random()*(inv.win[1]-inv.win[0]); }
    else{ roi = inv.lose[0] + Math.random()*(inv.lose[1]-inv.lose[0]); }
    const payout = Math.round(inv.amount * (1+roi));
    const pl = payout - inv.amount;
    p.balance += payout; if(pl>=0) p.income += pl; else p.expense += -pl;
    pushLedger(p,{title:`æŠ•è³‡äº‹æ¥­çµç®—ï¼${inv.name}ï¼ˆ${pl>=0?'+':'-'}$${money(Math.abs(pl))}ï¼‰`, amount:Math.abs(pl), type:pl>=0?'income':'expense', tag:'ğŸ“¦'});
    p.pendingVenture=null;
    // èª²ç¨‹åŠ æˆç”¨å®Œæ­¸é›¶
    if(buff>0) p.courseBuffNext = 0;

    // é¡¯ç¤ºçµæœå¡
    cardTitleEl.textContent='ğŸ“¦ æŠ•è³‡çµç®—';
    cardTextEl.innerHTML=`${inv.name}ï¼š${success?'æˆåŠŸ âœ…':'å¤±æ•— âŒ'}<br>å›æ”¶ï¼š$ ${money(payout)}ï¼ˆæç›Š ${pl>=0?'+':'-'}$ ${money(Math.abs(pl))}ï¼‰`;
    cardAmountEl.textContent='';
    cardAvatarEl.src = p.img; characterNameEl.textContent=p.name;
    stockActionsEl.style.display='none'; bankActionsEl.style.display='none'; holdingsEl.style.display='none'; ventureActionsEl.style.display='none';
    cardEl.style.display='block';
    okBtn.onclick=()=>{ cardEl.style.display='none'; };
    return true;
  }

  // === äº‹ä»¶è™•ç†ï¼ˆèª²ç¨‹ / æŠ•è³‡äº‹æ¥­ / ä½é™¢ï¼‰ ===
  function applyTileEffect(p){
    const tile=TILES[p.pos||0];
    buyBtn.style.display='none'; buyBtn.onclick=null;
    stockActionsEl.style.display='none'; bankActionsEl.style.display='none'; holdingsEl.style.display='none'; ventureActionsEl.style.display='none';
    btnBuy.onclick=null; btnSell.onclick=null;
    Array.from(extraBtns.querySelectorAll('.tmpbtn')).forEach(n=>n.remove());

    let title=''; let text=''; let delta=0;

    switch(tile.type){
      case 'start':
        title='èµ·é»'; text='å›åˆ°èµ·é»ï¼Œæº–å‚™å†å‡ºç™¼ã€‚'; delta=0; break;

      case 'tax': { const amt=tile.amount; title=tile.name; text='ç¹³äº¤ç¨…é‡‘ã€‚'; delta=-amt; p.expense+=amt; p.balance-=amt; break; }
      case 'donate': { const amt=tile.amount; title=tile.name; text='åšå…¬ç›Šææ¬¾ï¼Œå¹«åŠ©éœ€è¦çš„äººã€‚'; delta=-amt; p.expense+=amt; p.balance-=amt; break; }
      case 'shop': { const cost=randInt(tile.min, tile.max); title='è³¼ç‰©èŠ±è²»'; text='åœ¨å•†åº—è²·äº†éœ€è¦çš„æ±è¥¿ã€‚'; delta=-cost; p.expense+=cost; p.balance-=cost; break; }

      case 'stock': {
        // ä¸‹æ‹‰æ¸…å–®
        stockSelectEl.innerHTML='';
        MARKET.list.forEach(s=>{
          const opt=document.createElement('option'); opt.value=s.symbol; opt.textContent=`${s.symbol}ï¼ˆ${s.name}ï¼‰`;
          stockSelectEl.appendChild(opt);
        });
        stockSelectEl.selectedIndex = Math.floor(Math.random()*MARKET.list.length);
        const updatePriceUI = () => {
          const sym = stockSelectEl.value; const px = MARKET.price[sym]; const dy = MARKET.yield[sym]||0;
          stockPriceEl.textContent = (MARKET.halted[sym]>0)? 'åœç‰Œä¸­' : ('$ ' + money(px));
          stockYieldEl.textContent = (dy*100).toFixed(1)+'%';
          stockQtyEl.value = 1;
          cardTextEl.innerHTML = `æ¨™çš„ï¼š<b>${sym}</b>ï¼ˆå¯æ”¹é¸ï¼‰ï¼Œç¾åƒ¹ $ ${money(px)}ï¼Œæ®–åˆ©ç‡ ${(dy*100).toFixed(1)}%ã€‚<br><small class="helper">æ¼²è·Œå¹…æ¯æ¬¡é™åˆ¶ Â±10%ï¼Œé‡åœç‰Œå‰‡ç„¡æ³•è®Šå‹•ã€‚</small>`;
          renderHoldings(p, sym);
        };
        updatePriceUI();
        title=`è‚¡ç¥¨ï¼šè²·è³£`; delta=0;
        stockActionsEl.style.display='flex'; stockSelectEl.onchange = updatePriceUI;

        // è²·å…¥ï¼ˆå¯é¸è²¸æ¬¾ï¼‰
        btnBuy.onclick=()=>{
          const sym = stockSelectEl.value; const qty = Math.max(1, parseInt(stockQtyEl.value||'1',10));
          const px = MARKET.price[sym]; const cost = qty * px;
          const useLoan = useLoanStockEl.checked; const years = parseInt(stockLoanYearsEl.value||'3',10);
          if(useLoan){ createLoan(p, {amount:cost, purpose:'stock', years, name:`${sym}`}); }
          if(p.balance < cost){ alert('ç¾é‡‘ä¸è¶³ï¼Œæ”¹ç”¨ã€Œä½¿ç”¨è²¸æ¬¾ã€æˆ–é™ä½æ•¸é‡ã€‚'); return; }
          const cur = p.stocks[sym] || {qty:0,avg:0};
          const newQty = cur.qty + qty;
          const newAvg = newQty>0 ? Math.round(((cur.qty*cur.avg) + cost) / newQty) : 0;
          p.stocks[sym] = { qty:newQty, avg:newAvg };
          p.balance -= cost; p.expense += cost;
          pushLedger(p,{title:`è²·å…¥ ${sym} ${qty} è‚¡ï¼ˆ$ ${money(px)}ï¼‰`, amount:cost, type:'expense', tag:'ğŸ“ˆ'});
          renderStats(); updatePriceUI();
          cardTextEl.innerHTML = `è²·å…¥æˆåŠŸï¼Œ${sym} æŒæœ‰ ${newQty} è‚¡ï¼Œå¹³å‡æˆæœ¬ $ ${money(newAvg)}ã€‚`;
        };
        // è³£å‡º
        btnSell.onclick=()=>{
          const sym = stockSelectEl.value; const qty = Math.max(1, parseInt(stockQtyEl.value||'1',10));
          const cur = p.stocks[sym] || {qty:0,avg:0};
          if(cur.qty < qty){ alert('æŒè‚¡ä¸è¶³ã€‚'); return; }
          const px = MARKET.price[sym]; const proceeds = qty * px; const remainQty = cur.qty - qty;
          p.stocks[sym] = { qty: remainQty, avg: cur.avg };
          p.balance += proceeds; p.income += proceeds;
          pushLedger(p,{title:`è³£å‡º ${sym} ${qty} è‚¡ï¼ˆ$ ${money(px)}ï¼‰`, amount:proceeds, type:'income', tag:'ğŸ“‰'});
          renderStats(); updatePriceUI();
          cardTextEl.textContent = `è³£å‡ºæˆåŠŸï¼Œ${sym} å‰©é¤˜ ${remainQty} è‚¡ã€‚`;
        };
        break;
      }

      case 'property': {
        const me=currentIndex; const owner=tile.ownerIndex; const rent = (tile.baseRent||0) * (tile.level||1);
        const upgradeCost = Math.floor(tile.price * 0.6);
        if(owner==null){
          title=tile.name; text=`ç„¡äººæ“æœ‰ï¼Œå¯è³¼è²·ï¼ˆåƒ¹æ ¼ $ ${money(tile.price)}ï¼Œç§Ÿé‡‘ $ ${money(rent)}ï¼‰ã€‚`; delta=0;
          buyBtn.style.display='inline-block'; buyBtn.textContent = `ç¾é‡‘è³¼è²·ï¼ˆ$ ${money(tile.price)}ï¼‰`;
          buyBtn.onclick=()=>{
            if(p.balance < tile.price){ alert('ç¾é‡‘ä¸è¶³ï¼Œå¯ä½¿ç”¨ã€Œè²¸æ¬¾è³¼è²·ã€ã€‚'); return; }
            p.expense += tile.price; p.balance -= tile.price;
            pushLedger(p,{title:`è³¼è²· ${tile.name}`, amount:tile.price, type:'expense', tag:'ğŸ '});
            tile.ownerIndex = me; renderStats();
            cardTextEl.textContent = `å·²è³¼è²· ${tile.name}ï¼ç›®å‰ç­‰ç´š Lv${tile.level}ï¼Œç§Ÿé‡‘ $ ${money(rent)}ã€‚`;
            buyBtn.style.display='none';
          };
          // è²¸æ¬¾è³¼è²·é¸é …
          const termSel=document.createElement('select'); termSel.innerHTML = `<option value="1">1 å¹´</option><option value="2">2 å¹´</option><option value="3" selected>3 å¹´</option><option value="4">4 å¹´</option><option value="5">5 å¹´</option>`; termSel.className='tmpbtn';
          const loanBtn=document.createElement('button'); loanBtn.textContent='è²¸æ¬¾è³¼è²·'; loanBtn.className='tmpbtn';
          loanBtn.onclick=()=>{
            const years = parseInt(termSel.value||'3',10);
            createLoan(p, {amount:tile.price, purpose:'property', years, name:tile.name});
            p.expense += tile.price; p.balance -= tile.price;
            pushLedger(p,{title:`è³¼è²· ${tile.name}ï¼ˆè²¸æ¬¾ï¼‰`, amount:tile.price, type:'expense', tag:'ğŸ '});
            tile.ownerIndex = me; renderStats();
            cardTextEl.textContent = `å·²è³¼è²· ${tile.name}ï¼ˆè²¸æ¬¾ ${years} å¹´ï¼‰ã€‚ç›®å‰ç­‰ç´š Lv${tile.level}ï¼Œç§Ÿé‡‘ $ ${money(rent)}ã€‚`;
            buyBtn.style.display='none'; Array.from(extraBtns.querySelectorAll('.tmpbtn')).forEach(n=>n.remove());
          };
          extraBtns.insertBefore(termSel, okBtn); extraBtns.insertBefore(loanBtn, okBtn);
        } else if(owner!==me){
          title=tile.name; text=`æ­¤åœ°ç”¢å±¬æ–¼ ${players[owner].name}ï¼Œéœ€æ”¯ä»˜ç§Ÿé‡‘ $ ${money(rent)}ã€‚`;
          delta=-rent; p.expense+=rent; p.balance-=rent; players[owner].income+=rent; players[owner].balance+=rent;
        } else {
          title=tile.name; text=`ä½ æ“æœ‰é€™å€‹åœ°ç”¢ï¼ˆLv${tile.level}/${tile.maxLevel}ï¼‰ï¼Œå¯é¸æ“‡å‡ç´šæé«˜ç§Ÿé‡‘ã€‚`; delta=0;
          if(tile.level < tile.maxLevel){
            buyBtn.style.display='inline-block'; buyBtn.textContent = `å‡ç´šè‡³ Lv${tile.level+1}ï¼ˆ$ ${money(upgradeCost)}ï¼‰`;
            buyBtn.onclick=()=>{
              if(p.balance < upgradeCost){ alert('ç¾é‡‘ä¸è¶³'); return; }
              p.expense += upgradeCost; p.balance -= upgradeCost; tile.level += 1;
              pushLedger(p,{title:`${tile.name} å‡ç´šè‡³ Lv${tile.level}`, amount:upgradeCost, type:'expense', tag:'ğŸ '});
              renderStats(); const newRent = (tile.baseRent||0) * (tile.level||1);
              cardTextEl.textContent = `å‡ç´šæˆåŠŸï¼æ–°ç§Ÿé‡‘ $ ${money(newRent)}ã€‚`;
              if(tile.level>=tile.maxLevel) buyBtn.style.display='none';
            };
            // è²¸æ¬¾å‡ç´š
            const termSel=document.createElement('select'); termSel.innerHTML = `<option value="1">1 å¹´</option><option value="2">2 å¹´</option><option value="3" selected>3 å¹´</option><option value="4">4 å¹´</option><option value="5">5 å¹´</option>`; termSel.className='tmpbtn';
            const loanBtn=document.createElement('button'); loanBtn.textContent='è²¸æ¬¾å‡ç´š'; loanBtn.className='tmpbtn';
            loanBtn.onclick=()=>{
              const years = parseInt(termSel.value||'3',10);
              createLoan(p, {amount:upgradeCost, purpose:'property', years, name:`${tile.name} å‡ç´š`});
              p.expense += upgradeCost; p.balance -= upgradeCost; tile.level += 1;
              pushLedger(p,{title:`${tile.name} å‡ç´šï¼ˆè²¸æ¬¾ï¼‰Lv${tile.level}`, amount:upgradeCost, type:'expense', tag:'ğŸ '});
              renderStats(); const newRent = (tile.baseRent||0) * (tile.level||1);
              cardTextEl.textContent = `å‡ç´šæˆåŠŸï¼æ–°ç§Ÿé‡‘ $ ${money(newRent)}ã€‚`;
              if(tile.level>=tile.maxLevel){ buyBtn.style.display='none'; Array.from(extraBtns.querySelectorAll('.tmpbtn')).forEach(n=>n.remove()); }
            };
            extraBtns.insertBefore(termSel, okBtn); extraBtns.insertBefore(loanBtn, okBtn);
          } else { buyBtn.style.display='none'; }
        }
        break;
      }

      case 'event': default: {
        const ev=EVENTS[Math.floor(Math.random()*EVENTS.length)];
        if(ev.type==='course'){
          const kinds=[{k:'finance', n:'ç†è²¡èª²ç¨‹', fee:randInt(300,800)}, {k:'econ', n:'ç¶“æ¿Ÿå­¸', fee:randInt(300,800)}, {k:'mgmt', n:'ç®¡ç†å­¸', fee:randInt(300,800)}];
          const c = kinds[Math.floor(Math.random()*kinds.length)];
          title = `ğŸ“š ${c.n}`;
          if(p.balance<c.fee){
            text = `æƒ³ä¸Š ${c.n}ï¼ˆå­¸è²» $ ${money(c.fee)}ï¼‰ï¼Œä½†ç¾é‡‘ä¸è¶³ï¼Œæ”¹å¤©å†ä¾†ã€‚`;
            cardTitleEl.textContent=title; cardTextEl.innerHTML=text; cardAmountEl.textContent=''; cardAvatarEl.src=p.img; characterNameEl.textContent=p.name; cardEl.style.display='block';
            break;
          }
          p.balance -= c.fee; p.expense += c.fee;
          p.courses[c.k] = (p.courses[c.k]||0)+1;
          p.courseBuffNext = clamp((p.courseBuffNext||0)+0.10, 0, 0.30); // ä¸‹å›åˆæŠ•è³‡æˆåŠŸç‡ +10%ï¼Œä¸Šé™ +30%
          pushLedger(p,{title:`ç¹³äº¤ ${c.n} å­¸è²»`, amount:c.fee, type:'expense', tag:'ğŸ“š'});
          text = `å®Œæˆ ${c.n}ï¼ä¸‹å›åˆæŠ•è³‡æˆåŠŸç‡ <b>+10%</b>ï¼ˆç›®å‰åŠ æˆ ${(Math.round((p.courseBuffNext)*100))}%ï¼‰ã€‚<br>å‡è·æ‰€éœ€èª²ç¨‹ä¹ŸåŒæ­¥ç´¯ç©ã€‚`;
          cardTitleEl.textContent=title; cardTextEl.innerHTML=text; cardAmountEl.textContent=''; cardAvatarEl.src=p.img; characterNameEl.textContent=p.name; cardEl.style.display='block';
        }else if(ev.type==='venture'){
          return offerVenture(p);
        }else if(ev.type==='injury'){
          const fee = 300; // ä½é™¢èŠ±è²»
          p.skipTurns = (p.skipTurns||0)+1;
          p.balance -= fee; p.expense += fee;
          let payout = 0;
          if(p.insured){ payout = INSURANCE.claim; p.balance += payout; p.income += payout; }
          pushLedger(p,{title:`ä½é™¢è²»`, amount:fee, type:'expense', tag:'ğŸ¥'});
          if(payout>0) pushLedger(p,{title:`ä¿éšªç†è³ `, amount:payout, type:'income', tag:'ğŸ›¡ï¸'});
          title='ğŸ¥ å—å‚·ä½é™¢'; text=`ä½é™¢ä¼‘æ¯ï¼Œä¸‹ä¸€å›åˆå°‡è‡ªå‹•è·³éä¸€æ¬¡ã€‚å·²æ”¯å‡ºè²»ç”¨ $ ${money(fee)}${payout>0?`ï¼Œä¿éšªç†è³  $ ${money(payout)}`:''}ã€‚`; delta=0;
          cardTitleEl.textContent=title; cardTextEl.innerHTML=text; cardAmountEl.textContent=''; cardAvatarEl.src=p.img; characterNameEl.textContent=p.name; cardEl.style.display='block';
        }
        break;
      }
    }

    if(delta!==0){
      cardAmountEl.textContent = delta>0 ? ('æ”¶å…¥ +' + money(Math.abs(delta))) : ('æ”¯å‡º ' + money(Math.abs(delta)));
      cardAmountEl.style.color = delta>=0 ? 'var(--good)' : 'var(--bad)';
      pushLedger(p,{title, amount:Math.abs(delta), type: delta>=0?'income':'expense', tag:'ğŸ´'});
    }else{
      cardAmountEl.textContent = '';
    }
  }

  // === å¸‚å ´è¨ˆæ™‚å™¨ ===
  function startMarketTimer(){
    stopMarketTimer();
    marketTimer = setInterval(()=>{
      if(gameOver) return;
      MARKET.tickAll();
      renderStats();
      if(stockActionsEl.style.display!=='none'){
        const p=players[currentIndex];
        const sym = (document.getElementById('stockSelect')||{}).value;
        if(sym){
          $('stockPrice').textContent = (MARKET.halted[sym]>0)? 'åœç‰Œä¸­' : ('$ ' + money(MARKET.price[sym]||0));
          renderHoldings(p, sym);
        }
      }
    }, 5000);
  }
  function stopMarketTimer(){ if(marketTimer){ clearInterval(marketTimer); marketTimer=null; } }

  // === éŠæˆ²èµ·è¿„ ===
  function startGame({reseed=false}={}){
    if(players.length<1){ alert('è«‹è‡³å°‘åŠ å…¥ 1 ä½ç©å®¶'); return; }
    roundMax = clamp(parseInt(roundLimitInput.value||'200',10),1,200);
    const startMoney = Math.max(0, parseInt(startMoneyInput.value||'3000',10));

    roundNow=1; currentIndex=0; gameOver=false; allLedger.length=0;
    if(reseed){ TILES=buildTiles(PATH.length); MARKET.init(); }

    players = players.map(p=>{
      const bag={}; MARKET.list.forEach(s=>bag[s.symbol]={qty:0,avg:0});
      const np = { ...p, pos:0, income:0, expense:0, balance:startMoney, ledger:[], stocks:bag, bankDeposit:0, loans:[], skipTurns:0, laps:0, pendingVenture:null, courseBuffNext:0, insured:p.insured||false };
      np.ledger.push({ time:nowStr(), player:np.name, title:'åˆå§‹è³‡é‡‘', amount:startMoney, type:'income', tag:'ğŸ¬', balanceAfter:startMoney });
      return np;
    });

    gameEl.style.display='block';
    if(leftCol && setupEl){ leftCol.appendChild(setupEl); }

    startMarketTimer();
    renderStats();
    cardEl.style.display = 'none';
    saveToSlot(saveSlot);
  }

  function endGameByRounds(){
    const ranked = players.map((pp,idx)=>({ pp, idx, pv: propertyValueForPlayer(idx), sv: stockValueOf(pp), dep: pp.bankDeposit||0, loan: loansOutstanding(pp) }))
      .map(r=>({ ...r, nw: (r.pp.balance||0)+r.dep+r.pv+r.sv-r.loan }))
      .sort((a,b)=>b.nw-a.nw);
    const top = ranked[0];
    alert(`â±ï¸ é”åˆ° ${roundMax} å›åˆï¼Œ${top.pp.name} ä»¥è³‡ç”¢æ·¨å€¼ ${money(top.nw)} å…ƒæœ€é«˜ï¼ï¼ˆç¾é‡‘ ${money(top.pp.balance)}ï½œå­˜æ¬¾ ${money(ranked[0].dep)}ï½œåœ°ç”¢ ${money(ranked[0].pv)}ï½œè‚¡ç¥¨ ${money(ranked[0].sv)}ï½œè²¸æ¬¾ ${money(ranked[0].loan)}ï¼‰`);
    gameOver=true; stopMarketTimer();
  }

  function advanceTurn(){
    cardEl.style.display='none'; if(!players.length || gameOver) return;
    currentIndex = (currentIndex + 1) % players.length;
    if(currentIndex===0){
      roundNow+=1; if(roundNow>roundMax){ endGameByRounds(); return; }
    }
    renderStats(); resultEl.textContent='';

    const p=players[currentIndex];
    // å›åˆé–‹å§‹ï¼šå…ˆçµç®—æŠ•è³‡äº‹æ¥­
    if(resolveVentureIfAnyAtTurnStart(p)) return;

    // è‹¥æœ‰ä½é™¢è·³é
    if(p.skipTurns>0){
      p.skipTurns -= 1;
      cardTitleEl.textContent='ğŸ¥ ä½é™¢ä¼‘æ¯'; cardTextEl.textContent='æœ¬å›åˆè·³éä¸€æ¬¡ï¼Œä¸‹å›åˆå†åŠ æ²¹ï¼'; cardAmountEl.textContent='';
      cardAvatarEl.src = p.img; characterNameEl.textContent=p.name;
      stockActionsEl.style.display='none'; bankActionsEl.style.display='none'; holdingsEl.style.display='none'; ventureActionsEl.style.display='none';
      cardEl.style.display='block';
      okBtn.onclick=()=>{ cardEl.style.display='none'; advanceTurn(); };
    }
    autoSave();
  }

  // æ“²éª°
  diceEl.addEventListener('click',()=>{
    if(gameOver){ return; }
    if(!players.length){ alert('è«‹å…ˆåŠ å…¥ç©å®¶'); return; }
    const cardVisible = window.getComputedStyle(cardEl).display !== 'none'; if(cardVisible){ return; }

    MARKET.tickAll();

    const p=players[currentIndex];

    if(p.skipTurns>0){
      p.skipTurns -= 1;
      cardTitleEl.textContent='ğŸ¥ ä½é™¢ä¼‘æ¯'; cardTextEl.textContent='æœ¬å›åˆè·³éä¸€æ¬¡ï¼Œä¸‹å›åˆå†åŠ æ²¹ï¼'; cardAmountEl.textContent='';
      cardAvatarEl.src = p.img; characterNameEl.textContent=p.name; cardEl.style.display='block';
      okBtn.onclick=()=>{ cardEl.style.display='none'; advanceTurn(); }; return;
    }

    const prev = p.pos||0;
    const roll=Math.floor(Math.random()*6)+1; 
    p.pos = (prev+roll) % PATH.length; 
    const crossed = (prev + roll) >= PATH.length;
    resultEl.textContent=`ä½ æ“²å‡ºäº†ï¼š${roll}`;
    renderBoard();

    if(crossed){
      onCompleteLap(p);
      okBtn.onclick = ()=>{
        bankActionsEl.style.display='none';
        cardEl.style.display='none';
        applyTileEffect(p);
        autoSave();
      };
    }else{
      applyTileEffect(p); autoSave();
    }
  });

  okBtn.addEventListener('click', ()=>{ cardEl.style.display='none'; });
  nextBtn.addEventListener('click', advanceTurn);

  quickNewBtn.addEventListener('click',()=>startGame({reseed:false}));
  reseedNewBtn.addEventListener('click',()=>startGame({reseed:true}));
  startBtn.addEventListener('click',()=>startGame({reseed:true}));

  // å­˜æª” UI
  saveBtn.addEventListener('click', ()=> saveToSlot(saveSlot));
  loadBtn.addEventListener('click', ()=> loadFromSlot(saveSlot));
  newSlotBtn.addEventListener('click', ()=>{
    const n = prompt('å»ºç«‹æ–°å­˜æª”ä½ï¼Œè«‹è¼¸å…¥åç¨±ï¼ˆä¾‹å¦‚ slot2 / myAï¼‰', `slot${Math.floor(Math.random()*9)+2}`);
    if(!n) return; saveToSlot(n);
  });

  // å•Ÿå‹•
  buildJobSelect();
  buildAvatars();
  renderBoard();
  renderStats();

  // æ–¹ä¾¿æ“æ§ï¼šç©ºç™½éµæ“²éª°ã€Enter é—œå¡ç‰‡
  document.addEventListener('keydown', (e)=>{
    if(e.key===' '){ e.preventDefault(); diceEl.click(); }
    if(e.key==='Enter'){ e.preventDefault(); $('okBtn').click(); }
  });

  // åŸºæœ¬è‡ªæ¸¬ï¼ˆç¶²å€å¸¶ #testï¼‰
  function logTest(msg){ testOutput.style.display='block'; testOutput.textContent += msg + '\n'; }
  function runTests(){
    try{
      logTest('é–‹å§‹æ¸¬è©¦â€¦');
      console.assert(PATH.length===64,'PATH=64');
      const uniq=new Set(PATH); console.assert(uniq.size===64,'PATH ä¸é‡è¤‡');
      const tmp=buildTiles(PATH.length); console.assert(tmp.length===64,'TILES=64');
      logTest('âœ“ OK');
    }catch(e){ logTest('âŒ '+(e?.message||e)); }
  }
  if(location.hash==='#test'){ runTests(); }
});
</script>
</body>
</html>

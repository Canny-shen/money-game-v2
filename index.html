<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>理財遊戲進階版｜單一檔</title>
<style>
  :root{
    --bg:#f7f8fc; --card:#ffffff; --ink:#1f2937; --muted:#6b7280; --brand:#6366f1;
    --ok:#10b981; --warn:#f59e0b; --bad:#ef4444; --line:#e5e7eb;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans",sans-serif;color:var(--ink);background:var(--bg)}
  h1,h2,h3{margin:0 0 .5rem 0}
  button{cursor:pointer;border:0;border-radius:14px;padding:.65rem .9rem;background:var(--brand);color:#fff;font-weight:700}
  button[disabled]{opacity:.5;cursor:not-allowed}
  .wrap{display:grid;grid-template-columns:340px 1fr;gap:16px;padding:16px;max-width:1400px;margin:auto}
  .card{background:var(--card);border:1px solid var(--line);border-radius:18px;box-shadow:0 4px 16px rgba(15,23,42,.05)}
  .sidebar{display:flex;flex-direction:column;gap:16px}
  .section{padding:14px 16px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .muted{color:var(--muted)}
  .tag{display:inline-flex;align-items:center;gap:6px;background:#eef2ff;color:#3730a3;border-radius:999px;padding:.25rem .6rem;font-size:.8rem;font-weight:700}
  .grid{display:grid;gap:12px}
  .grid.cols-2{grid-template-columns:1fr 1fr}
  .grid.cols-3{grid-template-columns:repeat(3,1fr)}
  .grid.cols-4{grid-template-columns:repeat(4,1fr)}
  .hr{height:1px;background:var(--line);margin:.75rem 0}
  input,select{border:1px solid var(--line);border-radius:12px;padding:.55rem .6rem;background:#fff}
  .xs{font-size:.8rem}

  /* Board */
  .board{position:relative;display:grid;grid-template-columns:repeat(5,1fr);grid-auto-rows:88px;gap:6px;padding:10px}
  .tile{position:relative;border:2px solid var(--line);background:#fff;border-radius:16px;padding:6px;display:flex;justify-content:center;align-items:center;text-align:center;font-size:.9rem}
  .tile .label{font-weight:800}
  .tile.START{background:#ecfeff;border-color:#a5f3fc}
  .tile.COURSE{background:#f5f3ff;border-color:#ddd6fe}
  .tile.INVEST{background:#f0fdf4;border-color:#bbf7d0}
  .tile.STOCK{background:#fefce8;border-color:#fde68a}
  .tile.ESTATE{background:#fdf2f8;border-color:#fbcfe8}
  .tile.BANK{background:#eef2ff;border-color:#c7d2fe}
  .tile.INSURE{background:#eff6ff;border-color:#bfdbfe}
  .tile.HOSP{background:#fff1f2;border-color:#fecdd3}
  .tile.NEWS{background:#f1f5f9;border-color:#e2e8f0}

  /* Avatars on tiles */
  .pawn{position:absolute;bottom:2px;left:2px;display:flex;gap:4px;flex-wrap:wrap}
  .pawn .p{width:18px;height:18px;border-radius:4px;border:2px solid #fff;display:flex;align-items:center;justify-content:center;font-size:.7rem;font-weight:900;color:#111}

  /* Player list */
  .player{display:flex;align-items:center;gap:10px;padding:10px;border:1px dashed var(--line);border-radius:12px}
  .avatar{width:28px;height:28px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-weight:900;color:#111;border:2px solid #fff;box-shadow:0 2px 6px rgba(0,0,0,.06)}
  .money{font-variant-numeric:tabular-nums}
  .pill{border-radius:999px;padding:.2rem .5rem;background:#f3f4f6;font-weight:700}
  .pill.ok{background:#ecfdf5;color:#065f46}
  .pill.bad{background:#fef2f2;color:#991b1b}

  /* Modal */
  .modal{position:fixed;inset:0;background:rgba(2,6,23,.5);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
  .modal.active{display:flex}
  .sheet{width:min(800px,96vw);max-height:90vh;overflow:auto;background:#fff;border-radius:20px;border:1px solid var(--line);box-shadow:0 10px 30px rgba(0,0,0,.2)}
  .sheet .hd{padding:14px 16px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between}
  .sheet .bd{padding:14px 16px}

  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .warn{background:var(--warn)}
  .good{background:var(--ok)}
  .bad{background:var(--bad)}

  .footer{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:.75rem}

  .log{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:.9rem;max-height:200px;overflow:auto;background:#0b1220;color:#cbd5e1;border-radius:12px;padding:10px}

  .tiny{font-size:.72rem;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="card section">
      <h2>設定玩家</h2>
      <div class="grid cols-2" id="playerSetup"></div>
      <div class="hr"></div>
      <div class="row">
        <button id="addPlayerBtn">＋新增玩家</button>
        <button id="startBtn" class="good">開始遊戲</button>
      </div>
      <div class="tiny">最多 8 位玩家。每位要選擇一個職業與暱稱。</div>
    </div>

    <div class="card section">
      <h2>回合控制</h2>
      <div class="row"><span>目前玩家：</span><span id="turnTag" class="tag">—</span></div>
      <div class="row">
        <button id="rollBtn">擲骰子</button>
        <button id="endBtn" class="warn">結束回合</button>
      </div>
      <div class="hr"></div>
      <div class="grid" id="playerList"></div>
    </div>

    <div class="card section">
      <h2>市場快訊</h2>
      <div id="marketBox" class="grid"></div>
    </div>

    <div class="card section">
      <h2>事件紀錄</h2>
      <div id="log" class="log"></div>
    </div>
  </div>

  <!-- Main -->
  <div class="card section">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2>棋盤</h2>
      <div class="row">
        <span class="pill">每圈領薪水</span>
        <span class="pill">學費 → 下回合投資成功率 +10%</span>
        <span class="pill">可借貸、買保險、股票、地產</span>
      </div>
    </div>
    <div id="board" class="board"></div>
  </div>
</div>

<!-- Modal -->
<div id="modal" class="modal"><div class="sheet">
  <div class="hd"><div id="modalTitle">—</div><button id="closeModal">✕</button></div>
  <div class="bd" id="modalBody"></div>
</div></div>

<script>
// ===== Utilities =====
const $ = (sel, el=document) => el.querySelector(sel)
const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel))
const money = n => new Intl.NumberFormat('zh-Hant', {style:'currency', currency:'TWD', maximumFractionDigits:0}).format(n)
const clamp = (n, a, b) => Math.max(a, Math.min(b, n))
const rand = (a,b)=> Math.floor(Math.random()*(b-a+1))+a

// ===== Game Data =====
const colors = ['#fca5a5','#fdba74','#fcd34d','#86efac','#93c5fd','#c4b5fd','#f9a8d4','#a7f3d0']
const emojis = ['😺','🐶','🐼','🦊','🐵','🐰','🐨','🦄']

const careers = {
  工程師:{ levels:[{title:'初級工程師', salary:1200, lapsReq:0, courseReq:null},{title:'工程師', salary:1800, lapsReq:2, courseReq:'管理學'},{title:'資深工程師', salary:2600, lapsReq:4, courseReq:'理財學'}]},
  老師:{ levels:[{title:'代課老師', salary:1000, lapsReq:0, courseReq:null},{title:'正式老師', salary:1600, lapsReq:2, courseReq:'經濟學'},{title:'主任', salary:2300, lapsReq:4, courseReq:'管理學'}]},
  護理師:{ levels:[{title:'見習護理師', salary:1100, lapsReq:0, courseReq:null},{title:'護理師', salary:1700, lapsReq:2, courseReq:'理財學'},{title:'資深護理師', salary:2400, lapsReq:4, courseReq:'管理學'}]},
  廚師:{ levels:[{title:'學徒', salary:900, lapsReq:0, courseReq:null},{title:'主廚', salary:1500, lapsReq:2, courseReq:'經濟學'},{title:'餐廳主廚', salary:2200, lapsReq:4, courseReq:'管理學'}]},
  設計師:{ levels:[{title:'助理設計', salary:1000, lapsReq:0, courseReq:null},{title:'設計師', salary:1600, lapsReq:2, courseReq:'理財學'},{title:'資深設計', salary:2300, lapsReq:4, courseReq:'管理學'}]},
  業務:{ levels:[{title:'業務新手', salary:900, lapsReq:0, courseReq:null},{title:'業務', salary:1500, lapsReq:2, courseReq:'經濟學'},{title:'業務主管', salary:2400, lapsReq:4, courseReq:'管理學'}]},
  銀行員:{ levels:[{title:'櫃員', salary:1100, lapsReq:0, courseReq:null},{title:'專員', salary:1700, lapsReq:2, courseReq:'理財學'},{title:'副理', salary:2500, lapsReq:4, courseReq:'管理學'}]},
  創業家:{ levels:[{title:'SOHO', salary:800, lapsReq:0, courseReq:null},{title:'創業者', salary:1800, lapsReq:2, courseReq:'理財學'},{title:'企業主', salary:3000, lapsReq:4, courseReq:'管理學'}]},
}

const courses = [
  {key:'理財學', tuition:300},
  {key:'經濟學', tuition:300},
  {key:'管理學', tuition:300},
]

const ventures = [
  {key:'手作市集', baseSuccess:55, min:100, max:800, roi:[1.2,1.6], loss:[0.5,0.8]},
  {key:'線上課程', baseSuccess:50, min:200, max:1200, roi:[1.3,1.9], loss:[0.4,0.7]},
  {key:'二手翻賣', baseSuccess:60, min:80, max:600, roi:[1.15,1.5], loss:[0.6,0.85]},
  {key:'點心攤位', baseSuccess:52, min:150, max:1000, roi:[1.25,1.75], loss:[0.45,0.75]},
]

const stockList = [
  {sym:'TAI', name:'台灣指標', price:100, drift:0},
  {sym:'CHIP', name:'晶片同盟', price:80, drift:0},
  {sym:'GREEN', name:'綠能共好', price:60, drift:0},
]

const boardSpec = [
  {type:'START', label:'出發/領薪'},
  {type:'COURSE', label:'理財學'},
  {type:'ESTATE', label:'地產 A'},
  {type:'INVEST', label:'投資'},
  {type:'NEWS', label:'市場新聞'},

  {type:'COURSE', label:'經濟學'},
  {type:'STOCK', label:'股票交易'},
  {type:'ESTATE', label:'地產 B'},
  {type:'HOSP', label:'醫院'},
  {type:'BANK', label:'銀行'},

  {type:'COURSE', label:'管理學'},
  {type:'INVEST', label:'投資'},
  {type:'ESTATE', label:'地產 C'},
  {type:'INSURE', label:'保險'},
  {type:'NEWS', label:'市場新聞'},

  {type:'ESTATE', label:'地產 D'},
  {type:'STOCK', label:'股票交易'},
  {type:'INVEST', label:'投資'},
  {type:'ESTATE', label:'地產 E'},
  {type:'NEWS', label:'市場新聞'},
]

// ===== Game State =====
const game = {
  started:false,
  turn:0,
  players:[],
  board:[],
  stocks:JSON.parse(JSON.stringify(stockList)),
  log:[],
}

function pushLog(msg){
  game.log.unshift(msg)
  $('#log').innerHTML = game.log.slice(0,80).map(x=>`• ${x}`).join('\n')
}

// ===== Setup UI =====
const setup = {
  listEl: $('#playerSetup'),
  add(){
    const idx = setup.listEl.children.length
    if(idx>=8) return
    const wrap = document.createElement('div')
    wrap.className='card section'
    wrap.innerHTML = `
      <div class="row">
        <div class="avatar" style="background:${colors[idx]}">${emojis[idx]}</div>
        <input placeholder="玩家暱稱" value="玩家${idx+1}" data-k="name" style="flex:1"/>
      </div>
      <div class="row">
        <label class="xs muted">職業</label>
        <select data-k="career">
          ${Object.keys(careers).map(k=>`<option>${k}</option>`).join('')}
        </select>
      </div>
    `
    setup.listEl.appendChild(wrap)
  },
  collect(){
    return $$('#playerSetup .card').map((card,i)=>{
      return {
        id:i,
        name: $('[data-k="name"]',card).value.trim()||`玩家${i+1}`,
        color: colors[i],
        emoji: emojis[i],
        careerKey: $('[data-k="career"]',card).value,
      }
    })
  }
}

$('#addPlayerBtn').addEventListener('click', ()=> setup.add())
for(let i=0;i<2;i++) setup.add()

$('#startBtn').addEventListener('click', startGame)

function startGame(){
  if(game.started) return
  const configs = setup.collect()
  if(configs.length===0) return
  game.players = configs.map((c,i)=> newPlayer(c))
  game.turn = 0
  game.board = boardSpec.map((t,i)=>({i, ...t, owner:null, level:0}))
  game.started = true
  renderBoard()
  renderPlayers()
  updateTurnTag()
  pushLog('遊戲開始！')
}

function newPlayer({id,name,color,emoji,careerKey}){
  const level=0
  const career = careers[careerKey]
  return {
    id, name, color, emoji,
    cash: 4000, // 初始資金
    pos: 0, laps: 0,
    careerKey, level,
    courses:[],
    nextBuff:0, thisBuff:0,
    insurance:{has:false, coverage:0},
    stocks:{},
    properties:[], // tile index
    loans:[], // {principal, rate}
    pendingAction:null, // 用於投資面板等
  }
}

// ===== Rendering =====
function renderBoard(){
  const b = $('#board')
  b.innerHTML = ''
  game.board.forEach(tile=>{
    const el = document.createElement('div')
    el.className = `tile ${tile.type}`
    el.dataset.idx = tile.i
    el.innerHTML = `<div class="label">${tile.label}</div>`
    // pawns
    const pwrap = document.createElement('div')
    pwrap.className='pawn'
    game.players.filter(p=>p.pos===tile.i).forEach(p=>{
      const dot = document.createElement('div')
      dot.className='p'
      dot.style.background = p.color
      dot.textContent = p.emoji
      pwrap.appendChild(dot)
    })
    el.appendChild(pwrap)

    // estate owner badge
    if(tile.type==='ESTATE' && tile.owner!=null){
      const owner = game.players.find(p=>p.id===tile.owner)
      const badge = document.createElement('div')
      badge.style.position='absolute';badge.style.top='6px';badge.style.right='6px'
      badge.className='tag'
      badge.textContent = `Lv${tile.level}`
      badge.style.background = '#fee2e2';badge.style.color='#7f1d1d'
      el.appendChild(badge)
    }

    el.addEventListener('click',()=>onTileClick(tile))
    b.appendChild(el)
  })
  renderMarket()
}

function renderPlayers(){
  const box = $('#playerList')
  box.innerHTML = ''
  game.players.forEach((p,i)=>{
    const c = careers[p.careerKey].levels[p.level]
    const loan = totalLoan(p)
    const el = document.createElement('div')
    el.className='player'
    el.innerHTML = `
      <div class="avatar" style="background:${p.color}">${p.emoji}</div>
      <div style="flex:1">
        <div class="row" style="justify-content:space-between">
          <strong>${p.name}</strong>
          <span class="money">${money(p.cash)}</span>
        </div>
        <div class="xs muted">${p.careerKey} · ${c.title} · 薪水 ${money(c.salary)} · 圈數 ${p.laps}</div>
        <div class="row xs">
          <span class="pill ${loan>0?'bad':''}">貸款${loan>0?': '+money(loan):'：無'}</span>
          <span class="pill">課程：${p.courses.join('、')||'—'}</span>
          <span class="pill ${p.thisBuff>0?'ok':''}">本回合投資加成：${p.thisBuff}%</span>
        </div>
        <div class="row xs">
          <button onclick="openPromotion(${i})">升職</button>
          <button onclick="openStocks(${i})">股票</button>
          <button onclick="openBank(${i})">銀行</button>
          <button onclick="openInsurance(${i})">保險</button>
        </div>
      </div>
    `
    box.appendChild(el)
  })
}

function renderMarket(){
  const box = $('#marketBox')
  box.innerHTML = stockList.map((s,idx)=>{
    const cur = game.stocks[idx]
    return `<div class="row" style="justify-content:space-between;border:1px solid var(--line);border-radius:12px;padding:6px 8px">
      <div><strong>${s.sym}</strong> <span class="muted">${s.name}</span></div>
      <div class="money">${money(cur.price)}</div>
    </div>`
  }).join('')
}

function updateTurnTag(){
  if(!game.started) return $('#turnTag').textContent='—'
  const p = game.players[game.turn]
  $('#turnTag').textContent = `${p.name}`
  $('#rollBtn').disabled = false
  $('#endBtn').disabled = false
}

// ===== Turn Flow =====
$('#rollBtn').addEventListener('click', ()=>{
  const p = game.players[game.turn]
  // 進入自己回合時，把 nextBuff 轉成 thisBuff（僅本回合有效）
  if(p._entered!==true){
    p.thisBuff = p.nextBuff; p.nextBuff = 0; p._entered = true
  }
  const d = rand(1,6)
  movePlayer(p, d)
})

$('#endBtn').addEventListener('click', ()=> endTurn())

function movePlayer(p, steps){
  const prev = p.pos
  p.pos = (p.pos + steps)
  if(p.pos >= game.board.length){
    p.pos = p.pos % game.board.length
    p.laps += 1
    // 每圈領薪
    const sal = careers[p.careerKey].levels[p.level].salary
    p.cash += sal
    pushLog(`${p.name} 完成一圈，領取薪水 ${money(sal)}`)
    // 每圈計息（單純計息，不自動攤還）
    const interestPaid = payLoanInterest(p)
    if(interestPaid>0) pushLog(`${p.name} 支付貸款利息 ${money(interestPaid)}`)
    // 市場小幅波動 ±10%
    marketDrift()
  }
  pushLog(`${p.name} 擲出 ${steps}，前進到 ${tileLabel(p.pos)}`)
  renderBoard(); renderPlayers()
  handleTile(p, game.board[p.pos])
}

function endTurn(){
  const p = game.players[game.turn]
  p.thisBuff = 0
  p._entered = false
  game.turn = (game.turn + 1) % game.players.length
  renderBoard(); renderPlayers(); updateTurnTag()
}

function tileLabel(i){ return `${game.board[i].label}` }

// ===== Tiles =====
function onTileClick(tile){
  if(!game.started) return
  openTileAction(game.players[game.turn], tile)
}

function handleTile(p, tile){
  switch(tile.type){
    case 'START': /* 什麼都不做，薪水在跨越時計算 */ break
    case 'COURSE':
      openCourse(p, tile.label)
      break
    case 'INVEST':
      openInvest(p)
      break
    case 'STOCK':
      openStocks(p.id)
      break
    case 'ESTATE':
      openEstate(p, tile)
      break
    case 'BANK':
      openBank(p.id)
      break
    case 'INSURE':
      openInsurance(p.id)
      break
    case 'HOSP':
      hospitalEvent(p)
      break
    case 'NEWS':
      newsEvent()
      break
  }
}

function openTileAction(p, tile){
  // 允許玩家主動點擊當下格子重開面板
  handleTile(p, tile)
}

// ===== Course (學費→下回合投資+10%) =====
function openCourse(p, courseLabel){
  const c = courses.find(x=>x.key===courseLabel) || courses[0]
  showModal(`修習 ${c.key}`,(body,close)=>{
    body.innerHTML = `
      <p>繳交學費 <strong>${money(c.tuition)}</strong>，修畢後 <strong>下回合</strong> 投資成功率 +10%。</p>
      <div class="actions">
        <button class="good" id="pay">繳費並修課</button>
        <button class="warn" id="skip">先略過</button>
      </div>
    `
    $('#pay',body).addEventListener('click',()=>{
      if(p.cash < c.tuition){ alert('現金不足，可前往銀行借貸'); return }
      p.cash -= c.tuition
      if(!p.courses.includes(c.key)) p.courses.push(c.key)
      p.nextBuff = clamp((p.nextBuff||0)+10, 0, 50)
      pushLog(`${p.name} 修完 ${c.key}（學費 ${money(c.tuition)}），下回合投資+${p.nextBuff}%`)
      renderPlayers(); close();
    })
    $('#skip',body).addEventListener('click',()=>{ close() })
  })
}

// ===== Invest =====
function openInvest(p){
  showModal('投資事業',(body,close)=>{
    body.innerHTML = `
      <div class="grid cols-2">
        ${ventures.map((v,i)=>`
          <div style="border:1px solid var(--line);border-radius:12px;padding:8px">
            <div class="row" style="justify-content:space-between"><strong>${v.key}</strong><span class="muted xs">成功基礎 ${v.baseSuccess}%</span></div>
            <div class="xs muted">可投金額 ${money(v.min)} - ${money(v.max)}</div>
            <div class="xs muted">獲利 ${Math.round((v.roi[0]-1)*100)}%～${Math.round((v.roi[1]-1)*100)}%，失敗損失 ${Math.round((1-v.loss[1])*100)}%～${Math.round((1-v.loss[0])*100)}%</div>
            <div class="row" style="margin-top:6px">
              <input type="number" min="${v.min}" max="${v.max}" value="${v.min}" id="amt${i}" style="width:120px">
              <button onclick="doInvest(${p.id}, ${i})">投資</button>
            </div>
          </div>`).join('')}
      </div>
      <div class="footer tiny">投資成功率會套用本回合加成（來自上回合修課）。</div>
    `
  }, true)
}

function doInvest(pid, vid){
  const p = game.players[pid]
  const v = ventures[vid]
  const amt = Number($(`#amt${vid}`).value)
  if(!(amt>=v.min && amt<=v.max)){ alert('金額超出範圍'); return }
  if(p.cash < amt){
    if(confirm('現金不足，要向銀行借貸差額嗎？')){
      const diff = amt - p.cash
      takeLoan(p, diff, 0.02) // 每圈 2% 利息
      pushLog(`${p.name} 貸款 ${money(diff)} 用於投資`)
    } else return
  }
  p.cash -= amt
  const successRate = clamp(v.baseSuccess + (p.thisBuff||0), 5, 95)
  const roll = Math.random()*100
  if(roll < successRate){
    const mult = rndFloat(v.roi[0], v.roi[1])
    const profit = Math.round(amt*mult)
    p.cash += profit
    pushLog(`${p.name} 投資「${v.key}」成功！投入 ${money(amt)} 回收 ${money(profit)}（成功率${Math.round(successRate)}%）`)
  }else{
    const mult = rndFloat(v.loss[0], v.loss[1])
    const back = Math.round(amt*mult)
    p.cash += back
    pushLog(`${p.name} 投資「${v.key}」失敗… 回收 ${money(back)}（成功率${Math.round(successRate)}%）`)
  }
  renderPlayers(); closeModalNow() // 修正：關閉面板後可繼續回合/換手
}

function rndFloat(a,b){return a + Math.random()*(b-a)}

// ===== Estate =====
function openEstate(p, tile){
  const priceBase = 600
  const lvlPrice = priceBase*(tile.level+1)
  const rent = Math.round(lvlPrice*0.25)
  showModal(tile.label,(body)=>{
    if(tile.owner==null){
      body.innerHTML = `<p>可購買此地產，價格 <strong>${money(lvlPrice)}</strong>，未來其他玩家路過需付租金 <strong>${money(rent)}</strong>。</p>
      <div class="actions"><button id="buy">購買</button></div>`
      $('#buy',body).addEventListener('click',()=>{
        attemptPay(p, lvlPrice, `購買 ${tile.label}`)
        tile.owner = p.id; tile.level = 1; p.properties.push(tile.i)
        pushLog(`${p.name} 購買 ${tile.label}`)
        renderBoard(); renderPlayers(); closeModalNow()
      })
    }else if(tile.owner===p.id){
      const upPrice = lvlPrice
      const upRent = Math.round(upPrice*0.25)
      body.innerHTML = `<p>你擁有此地產（Lv${tile.level}）。升級價格 <strong>${money(upPrice)}</strong>，新租金約 <strong>${money(upRent)}</strong>。</p>
      <div class="actions"><button id="up">升級</button></div>`
      $('#up',body).addEventListener('click',()=>{
        attemptPay(p, upPrice, `升級 ${tile.label}`)
        tile.level += 1
        pushLog(`${p.name} 升級 ${tile.label} → Lv${tile.level}`)
        renderBoard(); renderPlayers(); closeModalNow()
      })
    }else{
      // pay rent
      const owner = game.players.find(x=>x.id===tile.owner)
      owner // just to be safe
      const charge = rent*tile.level
      body.innerHTML = `<p>這是 <strong>${owner.name}</strong> 的地產（Lv${tile.level}），需支付租金 <strong>${money(charge)}</strong>。</p>
      const ok = document.createElement('button'); ok.textContent='支付租金'; body.appendChild(ok)
      ok.addEventListener('click',()=>{
        transfer(p, owner, charge, `${p.name} 支付 ${owner.name} 租金`)
        renderPlayers(); closeModalNow()
      })
    }
  })
}

// ===== Stocks =====
function openStocks(pid){
  const p = typeof pid==='number'? game.players[pid] : pid
  showModal('股票交易',(body)=>{
    body.innerHTML = `
      <div class="grid cols-3">
        ${game.stocks.map((s,i)=>{
          const hold = p.stocks[s.sym]||0
          return `<div style="border:1px solid var(--line);border-radius:12px;padding:8px">
            <div class="row" style="justify-content:space-between"><strong>${s.sym}</strong><span class="muted xs">${s.name}</span></div>
            <div class="row" style="justify-content:space-between"><span>價格</span><strong>${money(s.price)}</strong></div>
            <div class="row xs"><span class="pill">持有：${hold} 股</span></div>
            <div class="row" style="margin-top:6px">
              <input type="number" min="1" value="1" id="qty${i}" style="width:80px">
              <button onclick="buyStock(${p.id}, ${i})">買入</button>
              <button class="bad" onclick="sellStock(${p.id}, ${i})">賣出</button>
            </div>
          </div>`
        }).join('')}
      </div>
      <div class="tiny">價格波動：每圈與新聞事件發生時，隨機 ±10%（含上限/下限保護）。</div>
    `
  })
}

function buyStock(pid, idx){
  const p = game.players[pid]; const s = game.stocks[idx]
  const q = Math.max(1, Number($(`#qty${idx}`).value)||1)
  const cost = s.price*q
  if(p.cash<cost){ if(confirm('現金不足，是否借貸？')){ takeLoan(p, cost-p.cash, 0.02) } else return }
  p.cash -= cost
  p.stocks[s.sym] = (p.stocks[s.sym]||0)+q
  pushLog(`${p.name} 買入 ${s.sym} × ${q}（${money(cost)}）`)
  renderPlayers()
}

function sellStock(pid, idx){
  const p = game.players[pid]; const s = game.stocks[idx]
  const q = Math.max(1, Number($(`#qty${idx}`).value)||1)
  const hold = p.stocks[s.sym]||0
  if(q>hold) return alert('持股不足')
  const gain = s.price*q
  p.cash += gain
  p.stocks[s.sym] = hold-q
  pushLog(`${p.name} 賣出 ${s.sym} × ${q}（${money(gain)}）`)
  renderPlayers()
}

function marketDrift(){
  game.stocks.forEach(s=>{
    const pct = (Math.random()*20-10) // -10~+10
    s.price = Math.max(10, Math.round(s.price*(1+pct/100)))
  })
  pushLog('市場波動：股價變動（±10%）')
  renderMarket()
}

function newsEvent(){
  const s = game.stocks[rand(0, game.stocks.length-1)]
  const good = Math.random()<0.5
  const pct = good? rand(5,10): -rand(5,10)
  s.price = Math.max(10, Math.round(s.price*(1+pct/100)))
  pushLog(`新聞事件：${s.sym} ${good?'利多':'利空'} ${pct>0?'+':''}${pct}% → ${money(s.price)}`)
  renderMarket()
}

// ===== Bank / Loans =====
function openBank(pid){
  const p = game.players[pid]
  showModal('銀行業務',(body)=>{
    body.innerHTML = `
      <div class="row" style="justify-content:space-between"><div>現金</div><strong>${money(p.cash)}</strong></div>
      <div class="hr"></div>
      <h3>申請貸款</h3>
      <div class="row"><input id="loanAmt" type="number" min="100" step="100" value="1000" style="width:140px"> 每圈利率 2%</div>
      <div class="actions"><button id="loanBtn">申請貸款</button></div>
      <div class="hr"></div>
      <h3>貸款明細</h3>
      <div id="loanList"></div>
      <div class="row" style="margin-top:6px"><input id="repayAmt" type="number" min="100" step="100" value="500" style="width:140px"><button class="bad" id="repayBtn">償還本金</button></div>
      <div class="tiny">系統每圈自動收取利息（2%）。可隨時手動償還本金。</div>
    `
    $('#loanBtn',body).addEventListener('click',()=>{
      const v = Number($('#loanAmt').value)
      if(v>0){ takeLoan(p, v, 0.02); renderPlayers(); renderLoans(body,p) }
    })
    $('#repayBtn',body).addEventListener('click',()=>{
      const v = Number($('#repayAmt').value)
      repayLoan(p, v); renderPlayers(); renderLoans(body,p)
    })
    renderLoans(body,p)
  })
}

function renderLoans(body,p){
  const box = $('#loanList',body)
  const total = totalLoan(p)
  if(total<=0) box.innerHTML = '<div class="muted xs">目前無貸款</div>'
  else box.innerHTML = `
    <div class="row" style="justify-content:space-between"><div>未償本金</div><strong>${money(total)}</strong></div>
    <div class="xs muted">每圈利息約 ${money(Math.round(total*0.02))}</div>`
}

function totalLoan(p){ return Math.round(p.loans.reduce((a,b)=>a+b.principal,0)) }
function takeLoan(p, amt, rate){ p.cash += amt; p.loans.push({principal:amt, rate}) }
function repayLoan(p, amt){
  if(amt<=0) return
  if(p.cash<amt){ alert('現金不足'); return }
  let remain = amt
  for(const L of p.loans){
    const pay = Math.min(L.principal, remain)
    L.principal -= pay; remain -= pay
    if(remain<=0) break
  }
  p.loans = p.loans.filter(L=>L.principal>0)
  p.cash -= (amt-remain)
  pushLog(`${p.name} 償還本金 ${money(amt-remain)}`)
}
function payLoanInterest(p){
  let paid = 0
  for(const L of p.loans){ const i = Math.round(L.principal*L.rate); if(i>0){ const pay = Math.min(p.cash, i); p.cash -= pay; paid += pay } }
  return paid
}

// ===== Insurance =====
function openInsurance(pid){
  const p = game.players[pid]
  showModal('保險',(body)=>{
    body.innerHTML = `
      <p>住院醫療保險：發生住院事件時，依保額給付理賠。</p>
      <div class="row">
        <label class="xs muted">保額</label>
        <select id="cov">
          <option value="500">${money(500)}</option>
          <option value="1000">${money(1000)}</option>
          <option value="1500">${money(1500)}</option>
        </select>
        <button id="buyIns">購買/更新</button>
      </div>
      <div class="xs">目前：${p.insurance.has? '已投保 '+money(p.insurance.coverage): '未投保'}</div>
    `
    $('#buyIns',body).addEventListener('click',()=>{
      const cov = Number($('#cov').value)
      const premium = Math.round(cov*0.2) // 20% 保費一次付清
      attemptPay(p, premium, '購買保險')
      p.insurance.has = true; p.insurance.coverage = cov
      pushLog(`${p.name} 購買保險，保額 ${money(cov)}（保費 ${money(premium)}）`)
      renderPlayers(); closeModalNow()
    })
  })
}

function hospitalEvent(p){
  const cost = rand(400,900)
  let pay = cost
  let claim = 0
  if(p.insurance.has){ claim = Math.min(cost, p.insurance.coverage); pay = cost-claim }
  if(pay>0){ if(p.cash<pay){
    const diff = pay - p.cash
    takeLoan(p, diff, 0.02)
    pushLog(`${p.name} 因住院申請貸款 ${money(diff)}`)
  } }
  p.cash -= pay
  if(claim>0) pushLog(`${p.name} 住院支出 ${money(cost)}，保險理賠 ${money(claim)}，自付 ${money(pay)}`)
  else pushLog(`${p.name} 住院支出 ${money(cost)}`)
  renderPlayers()
}

// ===== Promotion =====
function openPromotion(idx){
  const p = game.players[idx]
  const path = careers[p.careerKey].levels
  const next = path[p.level+1]
  showModal('升職',(body)=>{
    if(!next){ body.innerHTML = '<p>已達最高職等。</p>'; return }
    const okLaps = p.laps>=next.lapsReq
    const okCourse = !next.courseReq || p.courses.includes(next.courseReq)
    body.innerHTML = `
      <p>下一職等：<strong>${next.title}</strong>，薪水 ${money(next.salary)}；需求：圈數 ≥ ${next.lapsReq} 或修畢 ${next.courseReq||'—'}</p>
      <div class="actions"><button id="go" ${okLaps||okCourse?'':'disabled'}>升職</button></div>
      <div class="tiny">任一條件達成即可。</div>
    `
    $('#go',body).addEventListener('click',()=>{
      p.level += 1
      pushLog(`${p.name} 升職為 ${next.title}（新薪水 ${money(next.salary)}）`)
      renderPlayers(); closeModalNow()
    })
  })
}

// ===== Helpers =====
function attemptPay(p, amt, reason){
  if(p.cash>=amt){ p.cash-=amt; return true }
  if(confirm('現金不足，是否借貸？')){ takeLoan(p, amt-p.cash, 0.02); p.cash=0; pushLog(`${p.name} 貸款 ${money(amt)} 用於：${reason}`); return true }
  else throw new Error('insufficient')
}
function transfer(from, to, amt, memo){
  if(from.cash<amt){ takeLoan(from, amt-from.cash, 0.02); pushLog(`${from.name} 因支付需要貸款 ${money(amt-from.cash)}`) }
  from.cash-=amt; to.cash+=amt; pushLog(memo+`（${money(amt)}）`)
}

// ===== Modal system =====
const modal = $('#modal'); const mb = $('#modalBody'); const mt = $('#modalTitle')
$('#closeModal').addEventListener('click', ()=> closeModalNow())
function showModal(title, render, allowSticky){
  mt.textContent = title
  mb.innerHTML = ''
  modal.classList.add('active')
  render(mb, ()=>closeModalNow())
  if(!allowSticky){ /* 預設允許使用者手動關閉即可 */ }
}
function closeModalNow(){ modal.classList.remove('active'); }

// ===== Initial draw =====
renderBoard(); renderPlayers(); updateTurnTag()
</script>
</body>
</html>

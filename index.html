<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ç†è²¡éŠæˆ²é€²éšç‰ˆï½œå–®ä¸€æª”</title>
<style>
  :root{
    --bg:#f7f8fc; --card:#ffffff; --ink:#1f2937; --muted:#6b7280; --brand:#6366f1;
    --ok:#10b981; --warn:#f59e0b; --bad:#ef4444; --line:#e5e7eb;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans",sans-serif;color:var(--ink);background:var(--bg)}
  h1,h2,h3{margin:0 0 .5rem 0}
  button{cursor:pointer;border:0;border-radius:14px;padding:.65rem .9rem;background:var(--brand);color:#fff;font-weight:700}
  button[disabled]{opacity:.5;cursor:not-allowed}
  .wrap{display:grid;grid-template-columns:340px 1fr;gap:16px;padding:16px;max-width:1400px;margin:auto}
  .card{background:var(--card);border:1px solid var(--line);border-radius:18px;box-shadow:0 4px 16px rgba(15,23,42,.05)}
  .sidebar{display:flex;flex-direction:column;gap:16px}
  .section{padding:14px 16px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .muted{color:var(--muted)}
  .tag{display:inline-flex;align-items:center;gap:6px;background:#eef2ff;color:#3730a3;border-radius:999px;padding:.25rem .6rem;font-size:.8rem;font-weight:700}
  .grid{display:grid;gap:12px}
  .grid.cols-2{grid-template-columns:1fr 1fr}
  .grid.cols-3{grid-template-columns:repeat(3,1fr)}
  .grid.cols-4{grid-template-columns:repeat(4,1fr)}
  .hr{height:1px;background:var(--line);margin:.75rem 0}
  input,select{border:1px solid var(--line);border-radius:12px;padding:.55rem .6rem;background:#fff}
  .xs{font-size:.8rem}

  /* Board */
  .board{position:relative;display:grid;grid-template-columns:repeat(5,1fr);grid-auto-rows:88px;gap:6px;padding:10px}
  .tile{position:relative;border:2px solid var(--line);background:#fff;border-radius:16px;padding:6px;display:flex;justify-content:center;align-items:center;text-align:center;font-size:.9rem}
  .tile .label{font-weight:800}
  .tile.START{background:#ecfeff;border-color:#a5f3fc}
  .tile.COURSE{background:#f5f3ff;border-color:#ddd6fe}
  .tile.INVEST{background:#f0fdf4;border-color:#bbf7d0}
  .tile.STOCK{background:#fefce8;border-color:#fde68a}
  .tile.ESTATE{background:#fdf2f8;border-color:#fbcfe8}
  .tile.BANK{background:#eef2ff;border-color:#c7d2fe}
  .tile.INSURE{background:#eff6ff;border-color:#bfdbfe}
  .tile.HOSP{background:#fff1f2;border-color:#fecdd3}
  .tile.NEWS{background:#f1f5f9;border-color:#e2e8f0}

  /* Avatars on tiles */
  .pawn{position:absolute;bottom:2px;left:2px;display:flex;gap:4px;flex-wrap:wrap}
  .pawn .p{width:18px;height:18px;border-radius:4px;border:2px solid #fff;display:flex;align-items:center;justify-content:center;font-size:.7rem;font-weight:900;color:#111}

  /* Player list */
  .player{display:flex;align-items:center;gap:10px;padding:10px;border:1px dashed var(--line);border-radius:12px}
  .avatar{width:28px;height:28px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-weight:900;color:#111;border:2px solid #fff;box-shadow:0 2px 6px rgba(0,0,0,.06)}
  .money{font-variant-numeric:tabular-nums}
  .pill{border-radius:999px;padding:.2rem .5rem;background:#f3f4f6;font-weight:700}
  .pill.ok{background:#ecfdf5;color:#065f46}
  .pill.bad{background:#fef2f2;color:#991b1b}

  /* Modal */
  .modal{position:fixed;inset:0;background:rgba(2,6,23,.5);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
  .modal.active{display:flex}
  .sheet{width:min(800px,96vw);max-height:90vh;overflow:auto;background:#fff;border-radius:20px;border:1px solid var(--line);box-shadow:0 10px 30px rgba(0,0,0,.2)}
  .sheet .hd{padding:14px 16px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between}
  .sheet .bd{padding:14px 16px}

  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .warn{background:var(--warn)}
  .good{background:var(--ok)}
  .bad{background:var(--bad)}

  .footer{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:.75rem}

  .log{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:.9rem;max-height:200px;overflow:auto;background:#0b1220;color:#cbd5e1;border-radius:12px;padding:10px}

  .tiny{font-size:.72rem;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="card section">
      <h2>è¨­å®šç©å®¶</h2>
      <div class="grid cols-2" id="playerSetup"></div>
      <div class="hr"></div>
      <div class="row">
        <button id="addPlayerBtn">ï¼‹æ–°å¢ç©å®¶</button>
        <button id="startBtn" class="good">é–‹å§‹éŠæˆ²</button>
      </div>
      <div class="tiny">æœ€å¤š 8 ä½ç©å®¶ã€‚æ¯ä½è¦é¸æ“‡ä¸€å€‹è·æ¥­èˆ‡æš±ç¨±ã€‚</div>
    </div>

    <div class="card section">
      <h2>å›åˆæ§åˆ¶</h2>
      <div class="row"><span>ç›®å‰ç©å®¶ï¼š</span><span id="turnTag" class="tag">â€”</span></div>
      <div class="row">
        <button id="rollBtn">æ“²éª°å­</button>
        <button id="endBtn" class="warn">çµæŸå›åˆ</button>
      </div>
      <div class="hr"></div>
      <div class="grid" id="playerList"></div>
    </div>

    <div class="card section">
      <h2>å¸‚å ´å¿«è¨Š</h2>
      <div id="marketBox" class="grid"></div>
    </div>

    <div class="card section">
      <h2>äº‹ä»¶ç´€éŒ„</h2>
      <div id="log" class="log"></div>
    </div>
  </div>

  <!-- Main -->
  <div class="card section">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2>æ£‹ç›¤</h2>
      <div class="row">
        <span class="pill">æ¯åœˆé ˜è–ªæ°´</span>
        <span class="pill">å­¸è²» â†’ ä¸‹å›åˆæŠ•è³‡æˆåŠŸç‡ +10%</span>
        <span class="pill">å¯å€Ÿè²¸ã€è²·ä¿éšªã€è‚¡ç¥¨ã€åœ°ç”¢</span>
      </div>
    </div>
    <div id="board" class="board"></div>
  </div>
</div>

<!-- Modal -->
<div id="modal" class="modal"><div class="sheet">
  <div class="hd"><div id="modalTitle">â€”</div><button id="closeModal">âœ•</button></div>
  <div class="bd" id="modalBody"></div>
</div></div>

<script>
// ===== Utilities =====
const $ = (sel, el=document) => el.querySelector(sel)
const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel))
const money = n => new Intl.NumberFormat('zh-Hant', {style:'currency', currency:'TWD', maximumFractionDigits:0}).format(n)
const clamp = (n, a, b) => Math.max(a, Math.min(b, n))
const rand = (a,b)=> Math.floor(Math.random()*(b-a+1))+a

// ===== Game Data =====
const colors = ['#fca5a5','#fdba74','#fcd34d','#86efac','#93c5fd','#c4b5fd','#f9a8d4','#a7f3d0']
const emojis = ['ğŸ˜º','ğŸ¶','ğŸ¼','ğŸ¦Š','ğŸµ','ğŸ°','ğŸ¨','ğŸ¦„']

const careers = {
  å·¥ç¨‹å¸«:{ levels:[{title:'åˆç´šå·¥ç¨‹å¸«', salary:1200, lapsReq:0, courseReq:null},{title:'å·¥ç¨‹å¸«', salary:1800, lapsReq:2, courseReq:'ç®¡ç†å­¸'},{title:'è³‡æ·±å·¥ç¨‹å¸«', salary:2600, lapsReq:4, courseReq:'ç†è²¡å­¸'}]},
  è€å¸«:{ levels:[{title:'ä»£èª²è€å¸«', salary:1000, lapsReq:0, courseReq:null},{title:'æ­£å¼è€å¸«', salary:1600, lapsReq:2, courseReq:'ç¶“æ¿Ÿå­¸'},{title:'ä¸»ä»»', salary:2300, lapsReq:4, courseReq:'ç®¡ç†å­¸'}]},
  è­·ç†å¸«:{ levels:[{title:'è¦‹ç¿’è­·ç†å¸«', salary:1100, lapsReq:0, courseReq:null},{title:'è­·ç†å¸«', salary:1700, lapsReq:2, courseReq:'ç†è²¡å­¸'},{title:'è³‡æ·±è­·ç†å¸«', salary:2400, lapsReq:4, courseReq:'ç®¡ç†å­¸'}]},
  å»šå¸«:{ levels:[{title:'å­¸å¾’', salary:900, lapsReq:0, courseReq:null},{title:'ä¸»å»š', salary:1500, lapsReq:2, courseReq:'ç¶“æ¿Ÿå­¸'},{title:'é¤å»³ä¸»å»š', salary:2200, lapsReq:4, courseReq:'ç®¡ç†å­¸'}]},
  è¨­è¨ˆå¸«:{ levels:[{title:'åŠ©ç†è¨­è¨ˆ', salary:1000, lapsReq:0, courseReq:null},{title:'è¨­è¨ˆå¸«', salary:1600, lapsReq:2, courseReq:'ç†è²¡å­¸'},{title:'è³‡æ·±è¨­è¨ˆ', salary:2300, lapsReq:4, courseReq:'ç®¡ç†å­¸'}]},
  æ¥­å‹™:{ levels:[{title:'æ¥­å‹™æ–°æ‰‹', salary:900, lapsReq:0, courseReq:null},{title:'æ¥­å‹™', salary:1500, lapsReq:2, courseReq:'ç¶“æ¿Ÿå­¸'},{title:'æ¥­å‹™ä¸»ç®¡', salary:2400, lapsReq:4, courseReq:'ç®¡ç†å­¸'}]},
  éŠ€è¡Œå“¡:{ levels:[{title:'æ«ƒå“¡', salary:1100, lapsReq:0, courseReq:null},{title:'å°ˆå“¡', salary:1700, lapsReq:2, courseReq:'ç†è²¡å­¸'},{title:'å‰¯ç†', salary:2500, lapsReq:4, courseReq:'ç®¡ç†å­¸'}]},
  å‰µæ¥­å®¶:{ levels:[{title:'SOHO', salary:800, lapsReq:0, courseReq:null},{title:'å‰µæ¥­è€…', salary:1800, lapsReq:2, courseReq:'ç†è²¡å­¸'},{title:'ä¼æ¥­ä¸»', salary:3000, lapsReq:4, courseReq:'ç®¡ç†å­¸'}]},
}

const courses = [
  {key:'ç†è²¡å­¸', tuition:300},
  {key:'ç¶“æ¿Ÿå­¸', tuition:300},
  {key:'ç®¡ç†å­¸', tuition:300},
]

const ventures = [
  {key:'æ‰‹ä½œå¸‚é›†', baseSuccess:55, min:100, max:800, roi:[1.2,1.6], loss:[0.5,0.8]},
  {key:'ç·šä¸Šèª²ç¨‹', baseSuccess:50, min:200, max:1200, roi:[1.3,1.9], loss:[0.4,0.7]},
  {key:'äºŒæ‰‹ç¿»è³£', baseSuccess:60, min:80, max:600, roi:[1.15,1.5], loss:[0.6,0.85]},
  {key:'é»å¿ƒæ”¤ä½', baseSuccess:52, min:150, max:1000, roi:[1.25,1.75], loss:[0.45,0.75]},
]

const stockList = [
  {sym:'TAI', name:'å°ç£æŒ‡æ¨™', price:100, drift:0},
  {sym:'CHIP', name:'æ™¶ç‰‡åŒç›Ÿ', price:80, drift:0},
  {sym:'GREEN', name:'ç¶ èƒ½å…±å¥½', price:60, drift:0},
]

const boardSpec = [
  {type:'START', label:'å‡ºç™¼/é ˜è–ª'},
  {type:'COURSE', label:'ç†è²¡å­¸'},
  {type:'ESTATE', label:'åœ°ç”¢ A'},
  {type:'INVEST', label:'æŠ•è³‡'},
  {type:'NEWS', label:'å¸‚å ´æ–°è'},

  {type:'COURSE', label:'ç¶“æ¿Ÿå­¸'},
  {type:'STOCK', label:'è‚¡ç¥¨äº¤æ˜“'},
  {type:'ESTATE', label:'åœ°ç”¢ B'},
  {type:'HOSP', label:'é†«é™¢'},
  {type:'BANK', label:'éŠ€è¡Œ'},

  {type:'COURSE', label:'ç®¡ç†å­¸'},
  {type:'INVEST', label:'æŠ•è³‡'},
  {type:'ESTATE', label:'åœ°ç”¢ C'},
  {type:'INSURE', label:'ä¿éšª'},
  {type:'NEWS', label:'å¸‚å ´æ–°è'},

  {type:'ESTATE', label:'åœ°ç”¢ D'},
  {type:'STOCK', label:'è‚¡ç¥¨äº¤æ˜“'},
  {type:'INVEST', label:'æŠ•è³‡'},
  {type:'ESTATE', label:'åœ°ç”¢ E'},
  {type:'NEWS', label:'å¸‚å ´æ–°è'},
]

// ===== Game State =====
const game = {
  started:false,
  turn:0,
  players:[],
  board:[],
  stocks:JSON.parse(JSON.stringify(stockList)),
  log:[],
}

function pushLog(msg){
  game.log.unshift(msg)
  $('#log').innerHTML = game.log.slice(0,80).map(x=>`â€¢ ${x}`).join('\n')
}

// ===== Setup UI =====
const setup = {
  listEl: $('#playerSetup'),
  add(){
    const idx = setup.listEl.children.length
    if(idx>=8) return
    const wrap = document.createElement('div')
    wrap.className='card section'
    wrap.innerHTML = `
      <div class="row">
        <div class="avatar" style="background:${colors[idx]}">${emojis[idx]}</div>
        <input placeholder="ç©å®¶æš±ç¨±" value="ç©å®¶${idx+1}" data-k="name" style="flex:1"/>
      </div>
      <div class="row">
        <label class="xs muted">è·æ¥­</label>
        <select data-k="career">
          ${Object.keys(careers).map(k=>`<option>${k}</option>`).join('')}
        </select>
      </div>
    `
    setup.listEl.appendChild(wrap)
  },
  collect(){
    return $$('#playerSetup .card').map((card,i)=>{
      return {
        id:i,
        name: $('[data-k="name"]',card).value.trim()||`ç©å®¶${i+1}`,
        color: colors[i],
        emoji: emojis[i],
        careerKey: $('[data-k="career"]',card).value,
      }
    })
  }
}

$('#addPlayerBtn').addEventListener('click', ()=> setup.add())
for(let i=0;i<2;i++) setup.add()

$('#startBtn').addEventListener('click', startGame)

function startGame(){
  if(game.started) return
  const configs = setup.collect()
  if(configs.length===0) return
  game.players = configs.map((c,i)=> newPlayer(c))
  game.turn = 0
  game.board = boardSpec.map((t,i)=>({i, ...t, owner:null, level:0}))
  game.started = true
  renderBoard()
  renderPlayers()
  updateTurnTag()
  pushLog('éŠæˆ²é–‹å§‹ï¼')
}

function newPlayer({id,name,color,emoji,careerKey}){
  const level=0
  const career = careers[careerKey]
  return {
    id, name, color, emoji,
    cash: 4000, // åˆå§‹è³‡é‡‘
    pos: 0, laps: 0,
    careerKey, level,
    courses:[],
    nextBuff:0, thisBuff:0,
    insurance:{has:false, coverage:0},
    stocks:{},
    properties:[], // tile index
    loans:[], // {principal, rate}
    pendingAction:null, // ç”¨æ–¼æŠ•è³‡é¢æ¿ç­‰
  }
}

// ===== Rendering =====
function renderBoard(){
  const b = $('#board')
  b.innerHTML = ''
  game.board.forEach(tile=>{
    const el = document.createElement('div')
    el.className = `tile ${tile.type}`
    el.dataset.idx = tile.i
    el.innerHTML = `<div class="label">${tile.label}</div>`
    // pawns
    const pwrap = document.createElement('div')
    pwrap.className='pawn'
    game.players.filter(p=>p.pos===tile.i).forEach(p=>{
      const dot = document.createElement('div')
      dot.className='p'
      dot.style.background = p.color
      dot.textContent = p.emoji
      pwrap.appendChild(dot)
    })
    el.appendChild(pwrap)

    // estate owner badge
    if(tile.type==='ESTATE' && tile.owner!=null){
      const owner = game.players.find(p=>p.id===tile.owner)
      const badge = document.createElement('div')
      badge.style.position='absolute';badge.style.top='6px';badge.style.right='6px'
      badge.className='tag'
      badge.textContent = `Lv${tile.level}`
      badge.style.background = '#fee2e2';badge.style.color='#7f1d1d'
      el.appendChild(badge)
    }

    el.addEventListener('click',()=>onTileClick(tile))
    b.appendChild(el)
  })
  renderMarket()
}

function renderPlayers(){
  const box = $('#playerList')
  box.innerHTML = ''
  game.players.forEach((p,i)=>{
    const c = careers[p.careerKey].levels[p.level]
    const loan = totalLoan(p)
    const el = document.createElement('div')
    el.className='player'
    el.innerHTML = `
      <div class="avatar" style="background:${p.color}">${p.emoji}</div>
      <div style="flex:1">
        <div class="row" style="justify-content:space-between">
          <strong>${p.name}</strong>
          <span class="money">${money(p.cash)}</span>
        </div>
        <div class="xs muted">${p.careerKey} Â· ${c.title} Â· è–ªæ°´ ${money(c.salary)} Â· åœˆæ•¸ ${p.laps}</div>
        <div class="row xs">
          <span class="pill ${loan>0?'bad':''}">è²¸æ¬¾${loan>0?': '+money(loan):'ï¼šç„¡'}</span>
          <span class="pill">èª²ç¨‹ï¼š${p.courses.join('ã€')||'â€”'}</span>
          <span class="pill ${p.thisBuff>0?'ok':''}">æœ¬å›åˆæŠ•è³‡åŠ æˆï¼š${p.thisBuff}%</span>
        </div>
        <div class="row xs">
          <button onclick="openPromotion(${i})">å‡è·</button>
          <button onclick="openStocks(${i})">è‚¡ç¥¨</button>
          <button onclick="openBank(${i})">éŠ€è¡Œ</button>
          <button onclick="openInsurance(${i})">ä¿éšª</button>
        </div>
      </div>
    `
    box.appendChild(el)
  })
}

function renderMarket(){
  const box = $('#marketBox')
  box.innerHTML = stockList.map((s,idx)=>{
    const cur = game.stocks[idx]
    return `<div class="row" style="justify-content:space-between;border:1px solid var(--line);border-radius:12px;padding:6px 8px">
      <div><strong>${s.sym}</strong> <span class="muted">${s.name}</span></div>
      <div class="money">${money(cur.price)}</div>
    </div>`
  }).join('')
}

function updateTurnTag(){
  if(!game.started) return $('#turnTag').textContent='â€”'
  const p = game.players[game.turn]
  $('#turnTag').textContent = `${p.name}`
  $('#rollBtn').disabled = false
  $('#endBtn').disabled = false
}

// ===== Turn Flow =====
$('#rollBtn').addEventListener('click', ()=>{
  const p = game.players[game.turn]
  // é€²å…¥è‡ªå·±å›åˆæ™‚ï¼ŒæŠŠ nextBuff è½‰æˆ thisBuffï¼ˆåƒ…æœ¬å›åˆæœ‰æ•ˆï¼‰
  if(p._entered!==true){
    p.thisBuff = p.nextBuff; p.nextBuff = 0; p._entered = true
  }
  const d = rand(1,6)
  movePlayer(p, d)
})

$('#endBtn').addEventListener('click', ()=> endTurn())

function movePlayer(p, steps){
  const prev = p.pos
  p.pos = (p.pos + steps)
  if(p.pos >= game.board.length){
    p.pos = p.pos % game.board.length
    p.laps += 1
    // æ¯åœˆé ˜è–ª
    const sal = careers[p.careerKey].levels[p.level].salary
    p.cash += sal
    pushLog(`${p.name} å®Œæˆä¸€åœˆï¼Œé ˜å–è–ªæ°´ ${money(sal)}`)
    // æ¯åœˆè¨ˆæ¯ï¼ˆå–®ç´”è¨ˆæ¯ï¼Œä¸è‡ªå‹•æ”¤é‚„ï¼‰
    const interestPaid = payLoanInterest(p)
    if(interestPaid>0) pushLog(`${p.name} æ”¯ä»˜è²¸æ¬¾åˆ©æ¯ ${money(interestPaid)}`)
    // å¸‚å ´å°å¹…æ³¢å‹• Â±10%
    marketDrift()
  }
  pushLog(`${p.name} æ“²å‡º ${steps}ï¼Œå‰é€²åˆ° ${tileLabel(p.pos)}`)
  renderBoard(); renderPlayers()
  handleTile(p, game.board[p.pos])
}

function endTurn(){
  const p = game.players[game.turn]
  p.thisBuff = 0
  p._entered = false
  game.turn = (game.turn + 1) % game.players.length
  renderBoard(); renderPlayers(); updateTurnTag()
}

function tileLabel(i){ return `${game.board[i].label}` }

// ===== Tiles =====
function onTileClick(tile){
  if(!game.started) return
  openTileAction(game.players[game.turn], tile)
}

function handleTile(p, tile){
  switch(tile.type){
    case 'START': /* ä»€éº¼éƒ½ä¸åšï¼Œè–ªæ°´åœ¨è·¨è¶Šæ™‚è¨ˆç®— */ break
    case 'COURSE':
      openCourse(p, tile.label)
      break
    case 'INVEST':
      openInvest(p)
      break
    case 'STOCK':
      openStocks(p.id)
      break
    case 'ESTATE':
      openEstate(p, tile)
      break
    case 'BANK':
      openBank(p.id)
      break
    case 'INSURE':
      openInsurance(p.id)
      break
    case 'HOSP':
      hospitalEvent(p)
      break
    case 'NEWS':
      newsEvent()
      break
  }
}

function openTileAction(p, tile){
  // å…è¨±ç©å®¶ä¸»å‹•é»æ“Šç•¶ä¸‹æ ¼å­é‡é–‹é¢æ¿
  handleTile(p, tile)
}

// ===== Course (å­¸è²»â†’ä¸‹å›åˆæŠ•è³‡+10%) =====
function openCourse(p, courseLabel){
  const c = courses.find(x=>x.key===courseLabel) || courses[0]
  showModal(`ä¿®ç¿’ ${c.key}`,(body,close)=>{
    body.innerHTML = `
      <p>ç¹³äº¤å­¸è²» <strong>${money(c.tuition)}</strong>ï¼Œä¿®ç•¢å¾Œ <strong>ä¸‹å›åˆ</strong> æŠ•è³‡æˆåŠŸç‡ +10%ã€‚</p>
      <div class="actions">
        <button class="good" id="pay">ç¹³è²»ä¸¦ä¿®èª²</button>
        <button class="warn" id="skip">å…ˆç•¥é</button>
      </div>
    `
    $('#pay',body).addEventListener('click',()=>{
      if(p.cash < c.tuition){ alert('ç¾é‡‘ä¸è¶³ï¼Œå¯å‰å¾€éŠ€è¡Œå€Ÿè²¸'); return }
      p.cash -= c.tuition
      if(!p.courses.includes(c.key)) p.courses.push(c.key)
      p.nextBuff = clamp((p.nextBuff||0)+10, 0, 50)
      pushLog(`${p.name} ä¿®å®Œ ${c.key}ï¼ˆå­¸è²» ${money(c.tuition)}ï¼‰ï¼Œä¸‹å›åˆæŠ•è³‡+${p.nextBuff}%`)
      renderPlayers(); close();
    })
    $('#skip',body).addEventListener('click',()=>{ close() })
  })
}

// ===== Invest =====
function openInvest(p){
  showModal('æŠ•è³‡äº‹æ¥­',(body,close)=>{
    body.innerHTML = `
      <div class="grid cols-2">
        ${ventures.map((v,i)=>`
          <div style="border:1px solid var(--line);border-radius:12px;padding:8px">
            <div class="row" style="justify-content:space-between"><strong>${v.key}</strong><span class="muted xs">æˆåŠŸåŸºç¤ ${v.baseSuccess}%</span></div>
            <div class="xs muted">å¯æŠ•é‡‘é¡ ${money(v.min)} - ${money(v.max)}</div>
            <div class="xs muted">ç²åˆ© ${Math.round((v.roi[0]-1)*100)}%ï½${Math.round((v.roi[1]-1)*100)}%ï¼Œå¤±æ•—æå¤± ${Math.round((1-v.loss[1])*100)}%ï½${Math.round((1-v.loss[0])*100)}%</div>
            <div class="row" style="margin-top:6px">
              <input type="number" min="${v.min}" max="${v.max}" value="${v.min}" id="amt${i}" style="width:120px">
              <button onclick="doInvest(${p.id}, ${i})">æŠ•è³‡</button>
            </div>
          </div>`).join('')}
      </div>
      <div class="footer tiny">æŠ•è³‡æˆåŠŸç‡æœƒå¥—ç”¨æœ¬å›åˆåŠ æˆï¼ˆä¾†è‡ªä¸Šå›åˆä¿®èª²ï¼‰ã€‚</div>
    `
  }, true)
}

function doInvest(pid, vid){
  const p = game.players[pid]
  const v = ventures[vid]
  const amt = Number($(`#amt${vid}`).value)
  if(!(amt>=v.min && amt<=v.max)){ alert('é‡‘é¡è¶…å‡ºç¯„åœ'); return }
  if(p.cash < amt){
    if(confirm('ç¾é‡‘ä¸è¶³ï¼Œè¦å‘éŠ€è¡Œå€Ÿè²¸å·®é¡å—ï¼Ÿ')){
      const diff = amt - p.cash
      takeLoan(p, diff, 0.02) // æ¯åœˆ 2% åˆ©æ¯
      pushLog(`${p.name} è²¸æ¬¾ ${money(diff)} ç”¨æ–¼æŠ•è³‡`)
    } else return
  }
  p.cash -= amt
  const successRate = clamp(v.baseSuccess + (p.thisBuff||0), 5, 95)
  const roll = Math.random()*100
  if(roll < successRate){
    const mult = rndFloat(v.roi[0], v.roi[1])
    const profit = Math.round(amt*mult)
    p.cash += profit
    pushLog(`${p.name} æŠ•è³‡ã€Œ${v.key}ã€æˆåŠŸï¼æŠ•å…¥ ${money(amt)} å›æ”¶ ${money(profit)}ï¼ˆæˆåŠŸç‡${Math.round(successRate)}%ï¼‰`)
  }else{
    const mult = rndFloat(v.loss[0], v.loss[1])
    const back = Math.round(amt*mult)
    p.cash += back
    pushLog(`${p.name} æŠ•è³‡ã€Œ${v.key}ã€å¤±æ•—â€¦ å›æ”¶ ${money(back)}ï¼ˆæˆåŠŸç‡${Math.round(successRate)}%ï¼‰`)
  }
  renderPlayers(); closeModalNow() // ä¿®æ­£ï¼šé—œé–‰é¢æ¿å¾Œå¯ç¹¼çºŒå›åˆ/æ›æ‰‹
}

function rndFloat(a,b){return a + Math.random()*(b-a)}

// ===== Estate =====
function openEstate(p, tile){
  const priceBase = 600
  const lvlPrice = priceBase*(tile.level+1)
  const rent = Math.round(lvlPrice*0.25)
  showModal(tile.label,(body)=>{
    if(tile.owner==null){
      body.innerHTML = `<p>å¯è³¼è²·æ­¤åœ°ç”¢ï¼Œåƒ¹æ ¼ <strong>${money(lvlPrice)}</strong>ï¼Œæœªä¾†å…¶ä»–ç©å®¶è·¯ééœ€ä»˜ç§Ÿé‡‘ <strong>${money(rent)}</strong>ã€‚</p>
      <div class="actions"><button id="buy">è³¼è²·</button></div>`
      $('#buy',body).addEventListener('click',()=>{
        attemptPay(p, lvlPrice, `è³¼è²· ${tile.label}`)
        tile.owner = p.id; tile.level = 1; p.properties.push(tile.i)
        pushLog(`${p.name} è³¼è²· ${tile.label}`)
        renderBoard(); renderPlayers(); closeModalNow()
      })
    }else if(tile.owner===p.id){
      const upPrice = lvlPrice
      const upRent = Math.round(upPrice*0.25)
      body.innerHTML = `<p>ä½ æ“æœ‰æ­¤åœ°ç”¢ï¼ˆLv${tile.level}ï¼‰ã€‚å‡ç´šåƒ¹æ ¼ <strong>${money(upPrice)}</strong>ï¼Œæ–°ç§Ÿé‡‘ç´„ <strong>${money(upRent)}</strong>ã€‚</p>
      <div class="actions"><button id="up">å‡ç´š</button></div>`
      $('#up',body).addEventListener('click',()=>{
        attemptPay(p, upPrice, `å‡ç´š ${tile.label}`)
        tile.level += 1
        pushLog(`${p.name} å‡ç´š ${tile.label} â†’ Lv${tile.level}`)
        renderBoard(); renderPlayers(); closeModalNow()
      })
    }else{
      // pay rent
      const owner = game.players.find(x=>x.id===tile.owner)
      owner // just to be safe
      const charge = rent*tile.level
      body.innerHTML = `<p>é€™æ˜¯ <strong>${owner.name}</strong> çš„åœ°ç”¢ï¼ˆLv${tile.level}ï¼‰ï¼Œéœ€æ”¯ä»˜ç§Ÿé‡‘ <strong>${money(charge)}</strong>ã€‚</p>
      const ok = document.createElement('button'); ok.textContent='æ”¯ä»˜ç§Ÿé‡‘'; body.appendChild(ok)
      ok.addEventListener('click',()=>{
        transfer(p, owner, charge, `${p.name} æ”¯ä»˜ ${owner.name} ç§Ÿé‡‘`)
        renderPlayers(); closeModalNow()
      })
    }
  })
}

// ===== Stocks =====
function openStocks(pid){
  const p = typeof pid==='number'? game.players[pid] : pid
  showModal('è‚¡ç¥¨äº¤æ˜“',(body)=>{
    body.innerHTML = `
      <div class="grid cols-3">
        ${game.stocks.map((s,i)=>{
          const hold = p.stocks[s.sym]||0
          return `<div style="border:1px solid var(--line);border-radius:12px;padding:8px">
            <div class="row" style="justify-content:space-between"><strong>${s.sym}</strong><span class="muted xs">${s.name}</span></div>
            <div class="row" style="justify-content:space-between"><span>åƒ¹æ ¼</span><strong>${money(s.price)}</strong></div>
            <div class="row xs"><span class="pill">æŒæœ‰ï¼š${hold} è‚¡</span></div>
            <div class="row" style="margin-top:6px">
              <input type="number" min="1" value="1" id="qty${i}" style="width:80px">
              <button onclick="buyStock(${p.id}, ${i})">è²·å…¥</button>
              <button class="bad" onclick="sellStock(${p.id}, ${i})">è³£å‡º</button>
            </div>
          </div>`
        }).join('')}
      </div>
      <div class="tiny">åƒ¹æ ¼æ³¢å‹•ï¼šæ¯åœˆèˆ‡æ–°èäº‹ä»¶ç™¼ç”Ÿæ™‚ï¼Œéš¨æ©Ÿ Â±10%ï¼ˆå«ä¸Šé™/ä¸‹é™ä¿è­·ï¼‰ã€‚</div>
    `
  })
}

function buyStock(pid, idx){
  const p = game.players[pid]; const s = game.stocks[idx]
  const q = Math.max(1, Number($(`#qty${idx}`).value)||1)
  const cost = s.price*q
  if(p.cash<cost){ if(confirm('ç¾é‡‘ä¸è¶³ï¼Œæ˜¯å¦å€Ÿè²¸ï¼Ÿ')){ takeLoan(p, cost-p.cash, 0.02) } else return }
  p.cash -= cost
  p.stocks[s.sym] = (p.stocks[s.sym]||0)+q
  pushLog(`${p.name} è²·å…¥ ${s.sym} Ã— ${q}ï¼ˆ${money(cost)}ï¼‰`)
  renderPlayers()
}

function sellStock(pid, idx){
  const p = game.players[pid]; const s = game.stocks[idx]
  const q = Math.max(1, Number($(`#qty${idx}`).value)||1)
  const hold = p.stocks[s.sym]||0
  if(q>hold) return alert('æŒè‚¡ä¸è¶³')
  const gain = s.price*q
  p.cash += gain
  p.stocks[s.sym] = hold-q
  pushLog(`${p.name} è³£å‡º ${s.sym} Ã— ${q}ï¼ˆ${money(gain)}ï¼‰`)
  renderPlayers()
}

function marketDrift(){
  game.stocks.forEach(s=>{
    const pct = (Math.random()*20-10) // -10~+10
    s.price = Math.max(10, Math.round(s.price*(1+pct/100)))
  })
  pushLog('å¸‚å ´æ³¢å‹•ï¼šè‚¡åƒ¹è®Šå‹•ï¼ˆÂ±10%ï¼‰')
  renderMarket()
}

function newsEvent(){
  const s = game.stocks[rand(0, game.stocks.length-1)]
  const good = Math.random()<0.5
  const pct = good? rand(5,10): -rand(5,10)
  s.price = Math.max(10, Math.round(s.price*(1+pct/100)))
  pushLog(`æ–°èäº‹ä»¶ï¼š${s.sym} ${good?'åˆ©å¤š':'åˆ©ç©º'} ${pct>0?'+':''}${pct}% â†’ ${money(s.price)}`)
  renderMarket()
}

// ===== Bank / Loans =====
function openBank(pid){
  const p = game.players[pid]
  showModal('éŠ€è¡Œæ¥­å‹™',(body)=>{
    body.innerHTML = `
      <div class="row" style="justify-content:space-between"><div>ç¾é‡‘</div><strong>${money(p.cash)}</strong></div>
      <div class="hr"></div>
      <h3>ç”³è«‹è²¸æ¬¾</h3>
      <div class="row"><input id="loanAmt" type="number" min="100" step="100" value="1000" style="width:140px"> æ¯åœˆåˆ©ç‡ 2%</div>
      <div class="actions"><button id="loanBtn">ç”³è«‹è²¸æ¬¾</button></div>
      <div class="hr"></div>
      <h3>è²¸æ¬¾æ˜ç´°</h3>
      <div id="loanList"></div>
      <div class="row" style="margin-top:6px"><input id="repayAmt" type="number" min="100" step="100" value="500" style="width:140px"><button class="bad" id="repayBtn">å„Ÿé‚„æœ¬é‡‘</button></div>
      <div class="tiny">ç³»çµ±æ¯åœˆè‡ªå‹•æ”¶å–åˆ©æ¯ï¼ˆ2%ï¼‰ã€‚å¯éš¨æ™‚æ‰‹å‹•å„Ÿé‚„æœ¬é‡‘ã€‚</div>
    `
    $('#loanBtn',body).addEventListener('click',()=>{
      const v = Number($('#loanAmt').value)
      if(v>0){ takeLoan(p, v, 0.02); renderPlayers(); renderLoans(body,p) }
    })
    $('#repayBtn',body).addEventListener('click',()=>{
      const v = Number($('#repayAmt').value)
      repayLoan(p, v); renderPlayers(); renderLoans(body,p)
    })
    renderLoans(body,p)
  })
}

function renderLoans(body,p){
  const box = $('#loanList',body)
  const total = totalLoan(p)
  if(total<=0) box.innerHTML = '<div class="muted xs">ç›®å‰ç„¡è²¸æ¬¾</div>'
  else box.innerHTML = `
    <div class="row" style="justify-content:space-between"><div>æœªå„Ÿæœ¬é‡‘</div><strong>${money(total)}</strong></div>
    <div class="xs muted">æ¯åœˆåˆ©æ¯ç´„ ${money(Math.round(total*0.02))}</div>`
}

function totalLoan(p){ return Math.round(p.loans.reduce((a,b)=>a+b.principal,0)) }
function takeLoan(p, amt, rate){ p.cash += amt; p.loans.push({principal:amt, rate}) }
function repayLoan(p, amt){
  if(amt<=0) return
  if(p.cash<amt){ alert('ç¾é‡‘ä¸è¶³'); return }
  let remain = amt
  for(const L of p.loans){
    const pay = Math.min(L.principal, remain)
    L.principal -= pay; remain -= pay
    if(remain<=0) break
  }
  p.loans = p.loans.filter(L=>L.principal>0)
  p.cash -= (amt-remain)
  pushLog(`${p.name} å„Ÿé‚„æœ¬é‡‘ ${money(amt-remain)}`)
}
function payLoanInterest(p){
  let paid = 0
  for(const L of p.loans){ const i = Math.round(L.principal*L.rate); if(i>0){ const pay = Math.min(p.cash, i); p.cash -= pay; paid += pay } }
  return paid
}

// ===== Insurance =====
function openInsurance(pid){
  const p = game.players[pid]
  showModal('ä¿éšª',(body)=>{
    body.innerHTML = `
      <p>ä½é™¢é†«ç™‚ä¿éšªï¼šç™¼ç”Ÿä½é™¢äº‹ä»¶æ™‚ï¼Œä¾ä¿é¡çµ¦ä»˜ç†è³ ã€‚</p>
      <div class="row">
        <label class="xs muted">ä¿é¡</label>
        <select id="cov">
          <option value="500">${money(500)}</option>
          <option value="1000">${money(1000)}</option>
          <option value="1500">${money(1500)}</option>
        </select>
        <button id="buyIns">è³¼è²·/æ›´æ–°</button>
      </div>
      <div class="xs">ç›®å‰ï¼š${p.insurance.has? 'å·²æŠ•ä¿ '+money(p.insurance.coverage): 'æœªæŠ•ä¿'}</div>
    `
    $('#buyIns',body).addEventListener('click',()=>{
      const cov = Number($('#cov').value)
      const premium = Math.round(cov*0.2) // 20% ä¿è²»ä¸€æ¬¡ä»˜æ¸…
      attemptPay(p, premium, 'è³¼è²·ä¿éšª')
      p.insurance.has = true; p.insurance.coverage = cov
      pushLog(`${p.name} è³¼è²·ä¿éšªï¼Œä¿é¡ ${money(cov)}ï¼ˆä¿è²» ${money(premium)}ï¼‰`)
      renderPlayers(); closeModalNow()
    })
  })
}

function hospitalEvent(p){
  const cost = rand(400,900)
  let pay = cost
  let claim = 0
  if(p.insurance.has){ claim = Math.min(cost, p.insurance.coverage); pay = cost-claim }
  if(pay>0){ if(p.cash<pay){
    const diff = pay - p.cash
    takeLoan(p, diff, 0.02)
    pushLog(`${p.name} å› ä½é™¢ç”³è«‹è²¸æ¬¾ ${money(diff)}`)
  } }
  p.cash -= pay
  if(claim>0) pushLog(`${p.name} ä½é™¢æ”¯å‡º ${money(cost)}ï¼Œä¿éšªç†è³  ${money(claim)}ï¼Œè‡ªä»˜ ${money(pay)}`)
  else pushLog(`${p.name} ä½é™¢æ”¯å‡º ${money(cost)}`)
  renderPlayers()
}

// ===== Promotion =====
function openPromotion(idx){
  const p = game.players[idx]
  const path = careers[p.careerKey].levels
  const next = path[p.level+1]
  showModal('å‡è·',(body)=>{
    if(!next){ body.innerHTML = '<p>å·²é”æœ€é«˜è·ç­‰ã€‚</p>'; return }
    const okLaps = p.laps>=next.lapsReq
    const okCourse = !next.courseReq || p.courses.includes(next.courseReq)
    body.innerHTML = `
      <p>ä¸‹ä¸€è·ç­‰ï¼š<strong>${next.title}</strong>ï¼Œè–ªæ°´ ${money(next.salary)}ï¼›éœ€æ±‚ï¼šåœˆæ•¸ â‰¥ ${next.lapsReq} æˆ–ä¿®ç•¢ ${next.courseReq||'â€”'}</p>
      <div class="actions"><button id="go" ${okLaps||okCourse?'':'disabled'}>å‡è·</button></div>
      <div class="tiny">ä»»ä¸€æ¢ä»¶é”æˆå³å¯ã€‚</div>
    `
    $('#go',body).addEventListener('click',()=>{
      p.level += 1
      pushLog(`${p.name} å‡è·ç‚º ${next.title}ï¼ˆæ–°è–ªæ°´ ${money(next.salary)}ï¼‰`)
      renderPlayers(); closeModalNow()
    })
  })
}

// ===== Helpers =====
function attemptPay(p, amt, reason){
  if(p.cash>=amt){ p.cash-=amt; return true }
  if(confirm('ç¾é‡‘ä¸è¶³ï¼Œæ˜¯å¦å€Ÿè²¸ï¼Ÿ')){ takeLoan(p, amt-p.cash, 0.02); p.cash=0; pushLog(`${p.name} è²¸æ¬¾ ${money(amt)} ç”¨æ–¼ï¼š${reason}`); return true }
  else throw new Error('insufficient')
}
function transfer(from, to, amt, memo){
  if(from.cash<amt){ takeLoan(from, amt-from.cash, 0.02); pushLog(`${from.name} å› æ”¯ä»˜éœ€è¦è²¸æ¬¾ ${money(amt-from.cash)}`) }
  from.cash-=amt; to.cash+=amt; pushLog(memo+`ï¼ˆ${money(amt)}ï¼‰`)
}

// ===== Modal system =====
const modal = $('#modal'); const mb = $('#modalBody'); const mt = $('#modalTitle')
$('#closeModal').addEventListener('click', ()=> closeModalNow())
function showModal(title, render, allowSticky){
  mt.textContent = title
  mb.innerHTML = ''
  modal.classList.add('active')
  render(mb, ()=>closeModalNow())
  if(!allowSticky){ /* é è¨­å…è¨±ä½¿ç”¨è€…æ‰‹å‹•é—œé–‰å³å¯ */ }
}
function closeModalNow(){ modal.classList.remove('active'); }

// ===== Initial draw =====
renderBoard(); renderPlayers(); updateTurnTag()
</script>
</body>
</html>
